updateProfile {
    sqlText = """
     DECLARE
      lv_GPBPRXY_rec        gp_gpbprxy.gpbprxy_rec;
      lv_GPBPRXY_ref        gp_gpbprxy.gpbprxy_ref;

      lv_opt_out_adv_date   DATE := SYSDATE;

      lv_info               twgrinfo.twgrinfo_label%TYPE := 'SAVED';

         FUNCTION f_validate_date (p_date VARCHAR2)
           RETURN VARCHAR2
         IS
           f_date    DATE;
         BEGIN
           IF p_date IS NOT NULL THEN
             BEGIN
               IF twbkwbis.f_isdate (p_date, twbklibs.date_input_fmt) THEN
                 f_date := twbkwbis.f_fmtdate (p_date);
                 IF trunc(( sysdate - f_date)/365) > 150 THEN -- if the birthdate makes them over 150, error
                   RETURN NULL;
                 ELSE
                   RETURN p_date;
                 END IF;
               ELSE
                 RETURN NULL;
               END IF;
             EXCEPTION
               WHEN OTHERS THEN
                 RETURN NULL;
             END;
           END IF;
           RETURN NULL;
         END f_validate_date;

         FUNCTION GET_DATE(p_ind VARCHAR2) RETURN DATE
         IS
         BEGIN
           CASE
             WHEN p_ind = 'N'
           THEN
             RETURN NULL;
           ELSE
             RETURN SYSDATE;
           END CASE;
         END GET_DATE;

     BEGIN
          -- Get the proxy record
        lv_GPBPRXY_ref := gp_gpbprxy.F_Query_One (?);
        FETCH lv_GPBPRXY_ref INTO lv_GPBPRXY_rec;
        CLOSE lv_GPBPRXY_ref;

        gp_gpbprxy.P_Update (
          p_proxy_idm    => ?,
          p_first_name   => ?,
          p_last_name    => ?,
          p_user_id      => goksels.f_get_ssb_id_context,
          p_rowid        => lv_GPBPRXY_rec.R_INTERNAL_RECORD_ID
          );

            -- Update everything else except e-mail
                      -- but verify birthdate and null out if invalid
                          BEGIN
                             gp_gpbprxy.P_Update (
                                p_proxy_idm          => ?,
                                p_mi                 => goksels.f_clean_text(?),
                                p_surname_prefix     => goksels.f_clean_text(?),
                                p_name_prefix        => goksels.f_clean_text(?),
                                p_name_suffix        => goksels.f_clean_text(?),
                                p_pref_first_name    => goksels.f_clean_text(?),
                                p_phone_area         => goksels.f_clean_text(?),
                                p_phone_number       => goksels.f_clean_text(?),
                                p_phone_ext          => goksels.f_clean_text(?),
                                p_ctry_code_phone    => goksels.f_clean_text(?),
                                p_house_number       => goksels.f_clean_text(?),
                                p_street_line1       => goksels.f_clean_text(?),
                                p_street_line2       => goksels.f_clean_text(?),
                                p_street_line3       => goksels.f_clean_text(?),
                                p_street_line4       => goksels.f_clean_text(?),
                                p_city               => goksels.f_clean_text(?),
                                p_stat_code          => goksels.f_clean_text(?),
                                p_zip                => goksels.f_clean_text(?),
                                p_cnty_code          => goksels.f_clean_text(?),
                                p_natn_code          => goksels.f_clean_text(?),
                                p_sex                => goksels.f_clean_text(?),
                                p_birth_date         => TO_DATE (f_validate_date(?), twbklibs.date_input_fmt),
                                p_ssn                => goksels.f_clean_text(?),
                                p_opt_out_adv_date   => GET_DATE(?),
                                p_user_id            => goksels.f_get_ssb_id_context,
                                p_rowid              => lv_GPBPRXY_rec.R_INTERNAL_RECORD_ID);
                          EXCEPTION
                             WHEN OTHERS THEN lv_info := 'DATA_ERROR';
                          END;

          -- Update match-n-load tables for insert/update into General Person
          bwgkprxy.P_MatchLoad (?);

          gb_common.P_Commit;

      END ;

          """
}

test {
    sqlText = """
        declare

        x VARCHAR2(10);
        y NUMBER(2);
        z DATE;

        in_value VARCHAR2(10);

        my_cur SYS_REFCURSOR;
        begin

        in_value := ?;

        x := 'A';
        y := 10;

        ? := x;
        ? := y;
        ? := TO_DATE('2003/07/09', 'yyyy/mm/dd');

        ? := in_value;

        -- Handle Ref Cursor
        OPEN my_cur
        FOR
        SELECT 'mhitrik' AS my_column FROM dual;

        ? := my_cur;

        end;
    """
}


setProxy {
    sqlText = """
        DECLARE
               p_verify      gpbprxy.gpbprxy_salt%TYPE DEFAULT '!@#bogus!@#';
               lv_rowid              gb_common.internal_record_id_type;
               lv_GPBELTR_ref        gp_gpbeltr.gpbeltr_ref;
               lv_GPBELTR_rec        gp_gpbeltr.gpbeltr_rec;
               lv_GPBPRXY_rec        gp_gpbprxy.gpbprxy_rec;
               lv_GPBPRXY_ref        gp_gpbprxy.gpbprxy_ref;

               do_pin                varchar2(1);
               msg                   varchar2(100);
               lv_loginOut           varchar2(1);

 FUNCTION F_ActionVerify (p_proxyIDM    gpbprxy.gpbprxy_proxy_idm%TYPE,
                          p_CTYP        gtvctyp.gtvctyp_code%TYPE,
                          p_verify      gpbprxy.gpbprxy_salt%TYPE)
    RETURN BOOLEAN
 IS
    lv_ind   gtvotyp.gtvotyp_option_default%TYPE;

    CURSOR C_VerifySalt
    IS
       SELECT 'Y'
         FROM GPBPRXY
        WHERE GPBPRXY_SALT = p_verify AND GPBPRXY_PROXY_IDM = p_proxyIDM;
 BEGIN
    IF NVL (bwgkprxy.F_GetOption ('VERIFY_' || p_CTYP || '_ACTION'), 'N') = 'N'
    THEN
       RETURN FALSE;
    END IF;

    OPEN C_VerifySalt;

    FETCH C_VerifySalt INTO lv_ind;

    IF C_VerifySalt%FOUND
    THEN
       CLOSE C_VerifySalt;
       RETURN FALSE;
    END IF;

    CLOSE C_VerifySalt;

    RETURN TRUE;
 END F_ActionVerify;

        BEGIN
               lv_rowid := twbkbssf.f_decode_base64(?);

               lv_GPBELTR_ref := gp_gpbeltr.F_Query_By_Rowid(lv_rowid);

                FETCH lv_GPBELTR_ref INTO lv_GPBELTR_rec;

             IF lv_GPBELTR_ref%NOTFOUND THEN

                 lv_loginOut  := 'Y';
                 msg := 'token-error';

             -- Check for expiration date
             -- Check for action already executed
             ELSIF NVL (TRUNC(lv_GPBELTR_rec.R_CTYP_EXP_DATE), TRUNC(SYSDATE)) < TRUNC(SYSDATE)
                  OR lv_GPBELTR_rec.R_CTYP_EXE_DATE IS NOT NULL
             THEN
                 lv_loginOut  := 'Y';
                 msg := 'token-expire';

             ELSIF (lv_GPBELTR_ref%FOUND AND F_ActionVerify (lv_GPBELTR_rec.R_PROXY_IDM,
                             lv_GPBELTR_rec.R_CTYP_CODE,
                             TRIM(p_verify))) THEN

              ? := lv_GPBELTR_rec.R_PROXY_IDM;

              ?  := 'Y';

           ELSE
              do_pin := 'Y';
           END IF;

           ?  := do_pin;
           ?  := msg;
           ?  := lv_loginOut;

        EXCEPTION
          WHEN OTHERS THEN ? := 'Y';

         END ;

    """
}

setProxyVerify {
    sqlText = """
       DECLARE
              p_verify      gpbprxy.gpbprxy_salt%TYPE DEFAULT '!@#bogus!@#';
              lv_rowid              gb_common.internal_record_id_type;
              lv_GPBELTR_ref        gp_gpbeltr.gpbeltr_ref;
              lv_GPBELTR_rec        gp_gpbeltr.gpbeltr_rec;
              lv_GPBPRXY_rec        gp_gpbprxy.gpbprxy_rec;
              lv_GPBPRXY_ref        gp_gpbprxy.gpbprxy_ref;

              do_pin                varchar2(1);
              msg                   varchar2(100);

FUNCTION F_ActionVerify (p_proxyIDM    gpbprxy.gpbprxy_proxy_idm%TYPE,
                         p_CTYP        gtvctyp.gtvctyp_code%TYPE,
                         p_verify      gpbprxy.gpbprxy_salt%TYPE)
   RETURN BOOLEAN
IS
   lv_ind   gtvotyp.gtvotyp_option_default%TYPE;

   CURSOR C_VerifySalt
   IS
      SELECT 'Y'
        FROM GPBPRXY
       WHERE GPBPRXY_SALT = p_verify AND GPBPRXY_PROXY_IDM = p_proxyIDM;
BEGIN
   IF NVL (bwgkprxy.F_GetOption ('VERIFY_' || p_CTYP || '_ACTION'), 'N') = 'N'
   THEN
      RETURN FALSE;
   END IF;

   OPEN C_VerifySalt;

   FETCH C_VerifySalt INTO lv_ind;

   IF C_VerifySalt%FOUND
   THEN
      CLOSE C_VerifySalt;
      RETURN FALSE;
   END IF;

   CLOSE C_VerifySalt;

   RETURN TRUE;
END F_ActionVerify;

       BEGIN
              lv_rowid := twbkbssf.f_decode_base64(?);

              lv_GPBELTR_ref := gp_gpbeltr.F_Query_By_Rowid(lv_rowid);

               FETCH lv_GPBELTR_ref INTO lv_GPBELTR_rec;

            IF lv_GPBELTR_ref%NOTFOUND THEN

                ?  := 'Y';
                msg := 'token-error';

            ELSIF (lv_GPBELTR_ref%FOUND AND F_ActionVerify (lv_GPBELTR_rec.R_PROXY_IDM,
                            lv_GPBELTR_rec.R_CTYP_CODE,
                            TRIM(?))) THEN

             ? := lv_GPBELTR_rec.R_PROXY_IDM;

             ?  := 'Y';

          ELSE
             do_pin := 'Y';
          END IF;

          ?  := do_pin;
          ?  := msg;

       EXCEPTION
         WHEN OTHERS THEN ? := 'Y';

        END ;
    """
}

savePin {
    sqlText = """
      DECLARE
      lv_pinhash       gpbprxy.gpbprxy_pin%TYPE;
      lv_salt          gpbprxy.gpbprxy_salt%TYPE;
      lv_msg           gb_common.err_type;
      lv_error         varchar2(20);
      lv_GPBPRXY_rec   gp_gpbprxy.gpbprxy_rec;
      lv_GPBPRXY_ref   gp_gpbprxy.gpbprxy_ref;
      lv_context_hash  gpbprxy.gpbprxy_pin%TYPE;
      error_status     VARCHAR2(1);

      FUNCTION F_Validate_Credentials (
         p_email     gpbprxy.gpbprxy_email_address%TYPE DEFAULT NULL,
         p_pin       gpbprxy.gpbprxy_pin%TYPE           DEFAULT NULL,
         p_proxyIDM  gpbprxy.gpbprxy_proxy_idm%TYPE     DEFAULT NULL)
         RETURN VARCHAR2
      IS
         lv_proxyIDM      gpbprxy.gpbprxy_proxy_idm%TYPE;
         lv_pinhash       gpbprxy.gpbprxy_pin%TYPE;
         lv_GPBPRXY_rec   gp_gpbprxy.gpbprxy_rec;
         lv_GPBPRXY_ref   gp_gpbprxy.gpbprxy_ref;
      BEGIN
         -- Get proxy by e-mail address
         lv_proxyIDM := bwgkpxya.F_GetProxyIDM (p_email);

         IF NVL(lv_proxyIDM,0) <> p_proxyIDM THEN
            RETURN 'N';
         ELSE
           lv_GPBPRXY_ref := gp_gpbprxy.F_Query_One (lv_proxyIDM);

           FETCH lv_GPBPRXY_ref INTO lv_GPBPRXY_rec;

           CLOSE lv_GPBPRXY_ref;

           gspcrpt.P_SaltedHash (p_pin, lv_GPBPRXY_rec.R_SALT, lv_pinhash);

           -- Check for disabled PIN
           IF NVL(lv_GPBPRXY_rec.R_PIN_DISABLED_IND,'N') IN ('Y','E') THEN
             RETURN 'N';
           -- Check for expired PIN (unless it was a 'R'eset Pin condition or a 'C'reate new pin
           ELSIF NVL (TRUNC(lv_GPBPRXY_rec.R_PIN_EXP_DATE), TRUNC(SYSDATE)) < TRUNC(SYSDATE)  AND
                 NVL(lv_GPBPRXY_rec.R_PIN_DISABLED_IND,'N') = 'N' THEN
             RETURN 'N';
           -- Compare hashed values to authenticate PIN
           ELSIF lv_pinhash <> lv_GPBPRXY_rec.R_PIN THEN
             -- update invalid logins count
             --bwgkpxya.P_Update_Invalid_Login(lv_proxyIDM, lv_GPBPRXY_rec.R_PIN_DISABLED_IND, lv_GPBPRXY_rec.R_INV_LOGIN_CNT);
             RETURN 'N';
           ELSE
             RETURN 'Y';
           END IF;
         END IF;
      END F_Validate_Credentials;

      BEGIN

      lv_error := NULL;
      lv_msg   := NULL;

      IF F_Validate_Credentials (?, TRIM(?), ? ) = 'N' THEN
         lv_error := 'ERR_USER';
      ELSIF NVL (?, '1bogus1pin1') <> NVL (?, '2bogus2pin2') THEN
         lv_error := 'ERR_NOMATCH';
      ELSIF NVL(bwgkprxy.F_GetOption ('PIN_VALIDATION_VIA_GUAPPRF'),'Y') = 'Y' THEN
           gb_third_party_access_rules.p_validate_pinrules  (
             p_pidm             => 0,
             p_pin              => ?,
             p_pin_reusechk_ind => 'N',
             error_message      => lv_msg);
           if lv_msg is not null then
             lv_error := 'ERR_GUAPPRF';
           else
           -- The PIN rules do not check for leading spaces so we have to do that here, just in case
             IF TRIM(NVL (?, 'x')) <>  NVL (?, 'x') THEN
               lv_error := 'ERR_GUAPPRF';
               lv_msg   := g\$_NLS.Get('BWGKPXYA1-0050','SQL', 'PIN values may not start with or end with a space');
             END IF;
           end if;
      ELSIF LENGTH (NVL (?, 'x')) < bwgkprxy.F_GetOption ('PIN_LENGTH_MINIMUM') OR
            LENGTH (NVL (?, 'x')) < bwgkprxy.F_GetOption ('PIN_LENGTH_MINIMUM') THEN
              lv_error := 'ERR_TOOSHORT';
      ELSIF TRIM(NVL (?, 'x')) <>  NVL (?, 'x') THEN
              lv_error := 'ERR_GUAPPRF';
              lv_msg   := g\$_NLS.Get('BWGKPXYA1-0051','SQL', 'PIN values may not start with or end with a space');
      END IF;

      IF lv_error is not null then
       -- P_PA_ResetPin (p_proxyIDM, lv_error, replace(lv_msg,'::',' '));
       error_status := 'Y';
      ELSE
       error_status := 'N';
       lv_salt := gspcrpt.F_Get_Salt (LENGTH (?));
       gspcrpt.P_SaltedHash (?, lv_salt, lv_pinhash);

        gp_gpbprxy.P_Update (
           p_proxy_idm          => ?,
           p_pin_disabled_ind   => 'N',
           p_pin_exp_date       => SYSDATE + bwgkprxy.F_GetOption ('PIN_LIFETIME_DAYS'),
           p_pin                => lv_pinhash,
           p_inv_login_cnt      => 0,
           p_salt               => lv_salt,
           p_user_id            => goksels.f_get_ssb_id_context);

        gb_common.P_Commit;

       END IF;

          ?  := lv_error;
          ?  := lv_msg;
          ?  := error_status;

      END;
    """
}

getProxyPersonalInformation {
    sqlText = """
       DECLARE
        lv_GPBPRXY_rec gp_gpbprxy.gpbprxy_rec;
        lv_GPBPRXY_ref gp_gpbprxy.gpbprxy_ref;

        BEGIN

         ? := gp_gpbprxy.F_Query_One (to_number(?));

         END;
    """
}

storeLoginInHistory {
    sqlText = """
DECLARE
lv_hold_rowid  gb_common.internal_record_id_type;
lv_RETP        gtvretp.gtvretp_code%TYPE;

pidm GPRXREF.GPRXREF_PERSON_PIDM%TYPE;

CURSOR refProxy is SELECT DISTINCT GPRXREF_PERSON_PIDM
FROM GPRXREF
WHERE GPRXREF_PROXY_IDM = ?;

BEGIN
OPEN refProxy;
FETCH refProxy INTO pidm;
CLOSE refProxy;


 lv_RETP := gp_gprxref.F_GetXREF_RETP (?, pidm);

   IF bwgkprxy.F_GetOption ('LOGIN_IN_HISTORY', lv_RETP) = 'Y'
      THEN
         gp_gprhist.P_Create (
            p_proxy_idm    => to_number(?),
            p_person_pidm  => pidm,
            p_page_name    => G\$_NLS.Get ('BWGKPXYA1-0055', 'SQL', 'Display authorization menu'),
            p_old_auth_ind => 'L',
            p_new_auth_ind => 'L',
            p_create_user  => goksels.f_get_ssb_id_context,
            p_create_date  => SYSDATE,
            p_user_id      => goksels.f_get_ssb_id_context,
            p_rowid_out    => lv_hold_rowid
            );

            gb_common.P_Commit;
      END IF;

END;

    """
}

getProxyProfileUiRules {
    sqlText = """
DECLARE
      show_p_mi              VARCHAR2(1);
      show_p_surname_prefix   VARCHAR2(1);
      show_p_name_prefix        VARCHAR2(1);
      show_p_name_suffix        VARCHAR2(1);
      show_p_pref_first_name    VARCHAR2(1);
      p_email_address      VARCHAR2(1);
      show_p_phone_area         VARCHAR2(1);
      show_p_phone_number       VARCHAR2(1);
      show_p_phone_ext          VARCHAR2(1);
      show_p_ctry_code_phone    VARCHAR2(1);
      show_p_house_number       VARCHAR2(1);
      show_p_street_line1       VARCHAR2(1);
      show_p_street_line2       VARCHAR2(1);
      show_p_street_line3       VARCHAR2(1);
      show_p_street_line4       VARCHAR2(1);
      show_p_city               VARCHAR2(1);
      show_p_stat_code          VARCHAR2(1);
      show_p_zip                VARCHAR2(1);
      show_p_cnty_code          VARCHAR2(1);
      show_p_natn_code          VARCHAR2(1);
      show_p_sex                VARCHAR2(1);
      show_p_birth_date         VARCHAR2(1);
      show_p_ssn                VARCHAR2(1);
      show_p_opt_out_adv_date VARCHAR2(1);

     FUNCTION F_Required (p_OTYP gtvotyp.gtvotyp_code%TYPE)
         RETURN VARCHAR2
      IS
         lv_option_ind   gtvotyp.gtvotyp_option_default%TYPE;
         lv_max_ind      gtvotyp.gtvotyp_option_default%TYPE;

         CURSOR C_RETPlist
         IS
            SELECT DISTINCT GPRXREF_RETP_CODE
              FROM GPRXREF
             WHERE GPRXREF_PROXY_IDM = ?
                   AND TRUNC (SYSDATE) BETWEEN TRUNC (GPRXREF_START_DATE)
                                           AND TRUNC (GPRXREF_STOP_DATE);
      BEGIN
         lv_max_ind := 'N';

         FOR lv_code IN C_RETPlist
         LOOP
            lv_option_ind :=
               NVL (bwgkprxy.F_GetOption (p_OTYP, lv_code.GPRXREF_RETP_CODE),'N');

            IF lv_option_ind > lv_max_ind
            THEN
               lv_max_ind := lv_option_ind;
            END IF;
         END LOOP;

         RETURN lv_max_ind;
      END F_Required;

BEGIN

         show_p_name_prefix := F_Required ('PROFILE_NAME_PREFIX');

         show_p_mi := F_Required ('PROFILE_MI');

         show_p_surname_prefix := F_Required ('PROFILE_SURNAME_PREFIX');

         show_p_name_suffix := F_Required ('PROFILE_NAME_SUFFIX');

         show_p_pref_first_name := F_Required ('PROFILE_PREF_FIRST_NAME');

         show_p_phone_area := F_Required ('PROFILE_PHONE_AREA');

         show_p_phone_number := F_Required ('PROFILE_PHONE_NUMBER');

         show_p_phone_ext := F_Required ('PROFILE_PHONE_EXT');

         show_p_ctry_code_phone := F_Required ('PROFILE_PHONE_COUNTRY');

         show_p_house_number := F_Required ('PROFILE_HOUSE_NUMBER');

         show_p_street_line1 := F_Required ('PROFILE_STREET_LINE1');

         show_p_street_line2 := F_Required ('PROFILE_STREET_LINE2');

         show_p_street_line3 := F_Required ('PROFILE_STREET_LINE3');

         show_p_street_line4 := F_Required ('PROFILE_STREET_LINE4');

         show_p_city := F_Required ('PROFILE_CITY');

         show_p_stat_code := F_Required ('PROFILE_STAT_CODE');

         show_p_zip := F_Required ('PROFILE_ZIP');

         show_p_cnty_code := F_Required ('PROFILE_CNTY_CODE');

         show_p_natn_code := F_Required ('PROFILE_NATN_CODE');

         show_p_sex := F_Required ('PROFILE_SEX');

         show_p_birth_date := F_Required ('PROFILE_BIRTH_DATE');

         show_p_ssn := F_Required ('PROFILE_SSN');

         show_p_opt_out_adv_date := F_Required ('PROFILE_OPT_OUT_ADV_IND');

         ? := show_p_name_prefix;
         ? := show_p_mi;
         ? := show_p_surname_prefix;
         ? := show_p_name_suffix;
         ? := show_p_pref_first_name;
         ? := show_p_phone_area;
         ? := show_p_phone_number;
         ? := show_p_phone_ext;
         ? := show_p_ctry_code_phone;
         ? := show_p_house_number;
         ? := show_p_street_line1;
         ? := show_p_street_line2;
         ? := show_p_street_line3;
         ? := show_p_street_line4;
         ? := show_p_city;
         ? := show_p_stat_code;
         ? := show_p_zip;
         ? := show_p_cnty_code;
         ? := show_p_natn_code;
         ? := show_p_sex;
         ? := show_p_birth_date;
         ? := show_p_ssn;
         ? := show_p_opt_out_adv_date;
END;

    """
}


checkProxyProfileRequiredData {
    sqlText = """
    DECLARE
    lv_message VARCHAR2 (30000);

    FUNCTION f_validate_date (p_date VARCHAR2)
         RETURN VARCHAR2
       IS
         f_date    DATE;
       BEGIN
         IF p_date IS NOT NULL THEN
           BEGIN
             IF twbkwbis.f_isdate (p_date, twbklibs.date_input_fmt) THEN
               f_date := twbkwbis.f_fmtdate (p_date);
               IF trunc(( sysdate - f_date)/365) > 150 THEN -- if the birthdate makes them over 150, error
                 RETURN NULL;
               ELSE
                 RETURN p_date;
               END IF;
             ELSE
               RETURN NULL;
             END IF;
           EXCEPTION
             WHEN OTHERS THEN
               RETURN NULL;
           END;
         END IF;
         RETURN NULL;
     END f_validate_date;

 FUNCTION f_find_missing_data(
      p_proxy_idm          gpbprxy.gpbprxy_proxy_idm%TYPE,
      p_first_name         gpbprxy.gpbprxy_first_name%TYPE DEFAULT NULL,
      p_mi                 gpbprxy.gpbprxy_mi%TYPE DEFAULT NULL,
      p_last_name          gpbprxy.gpbprxy_last_name%TYPE DEFAULT NULL,
      p_surname_prefix     gpbprxy.gpbprxy_surname_prefix%TYPE DEFAULT NULL,
      p_name_prefix        gpbprxy.gpbprxy_name_prefix%TYPE DEFAULT NULL,
      p_name_suffix        gpbprxy.gpbprxy_name_suffix%TYPE DEFAULT NULL,
      p_pref_first_name    gpbprxy.gpbprxy_pref_first_name%TYPE DEFAULT NULL,
      p_email_address      gpbprxy.gpbprxy_email_address%TYPE DEFAULT NULL,
      p_phone_area         gpbprxy.gpbprxy_phone_area%TYPE DEFAULT NULL,
      p_phone_number       gpbprxy.gpbprxy_phone_number%TYPE DEFAULT NULL,
      p_phone_ext          gpbprxy.gpbprxy_phone_ext%TYPE DEFAULT NULL,
      p_ctry_code_phone    gpbprxy.gpbprxy_ctry_code_phone%TYPE DEFAULT NULL,
      p_house_number       gpbprxy.gpbprxy_house_number%TYPE DEFAULT NULL,
      p_street_line1       gpbprxy.gpbprxy_street_line1%TYPE DEFAULT NULL,
      p_street_line2       gpbprxy.gpbprxy_street_line2%TYPE DEFAULT NULL,
      p_street_line3       gpbprxy.gpbprxy_street_line3%TYPE DEFAULT NULL,
      p_street_line4       gpbprxy.gpbprxy_street_line4%TYPE DEFAULT NULL,
      p_city               gpbprxy.gpbprxy_city%TYPE DEFAULT NULL,
      p_stat_code          gpbprxy.gpbprxy_stat_code%TYPE DEFAULT NULL,
      p_zip                gpbprxy.gpbprxy_zip%TYPE DEFAULT NULL,
      p_cnty_code          gpbprxy.gpbprxy_cnty_code%TYPE DEFAULT NULL,
      p_natn_code          gpbprxy.gpbprxy_natn_code%TYPE DEFAULT NULL,
      p_sex                gpbprxy.gpbprxy_sex%TYPE DEFAULT NULL,
      p_birth_date         VARCHAR2 DEFAULT NULL,
      p_ssn                gpbprxy.gpbprxy_ssn%TYPE DEFAULT NULL)
   RETURN VARCHAR2
   IS
      lv_message            VARCHAR2 (30000);
      lv_info               twgrinfo.twgrinfo_label%TYPE := 'SAVED';
      lv_req_ind            gtvotyp.gtvotyp_option_default%TYPE;
      -- Determine whether to display the profile element
      -- N means no display or no rules where found or no relationship records exist yet
      -- V means element is visible but not required
      -- Y means element is visible and required
      FUNCTION F_Required (p_OTYP gtvotyp.gtvotyp_code%TYPE)
         RETURN VARCHAR2
      IS
         lv_option_ind   gtvotyp.gtvotyp_option_default%TYPE;
         lv_max_ind      gtvotyp.gtvotyp_option_default%TYPE;

         CURSOR C_RETPlist
         IS
            SELECT DISTINCT GPRXREF_RETP_CODE
              FROM GPRXREF
             WHERE GPRXREF_PROXY_IDM = p_proxy_idm
                   AND TRUNC (SYSDATE) BETWEEN TRUNC (GPRXREF_START_DATE)
                                           AND TRUNC (GPRXREF_STOP_DATE);
      BEGIN
         lv_max_ind := 'N';

         FOR lv_code IN C_RETPlist
         LOOP
            lv_option_ind :=
               NVL (bwgkprxy.F_GetOption (p_OTYP, lv_code.GPRXREF_RETP_CODE),'N');

            IF lv_option_ind > lv_max_ind
            THEN
               lv_max_ind := lv_option_ind;
            END IF;
         END LOOP;

         RETURN lv_max_ind;
      END F_Required;
      --
      --
      --
      PROCEDURE P_Check_If_Missing (p_parm VARCHAR2, p_data VARCHAR2, p_msg VARCHAR2)
      IS
      BEGIN
        lv_req_ind := F_Required (p_parm);

        IF lv_req_ind = 'Y' AND goksels.f_clean_text(p_data) IS NULL
        THEN
           lv_info := 'REQUIRED';
           lv_message :=
              lv_message || ' : ' || p_msg;
        END IF;
      END P_Check_If_Missing;
   --
   --
   --
   BEGIN
      lv_message := G\$_NLS.Get ('BWGKPXYA1-0000', 'SQL', 'Required data missing');

      -- Check first name (always required)
      IF goksels.f_clean_text(p_first_name) IS NULL
      THEN
         lv_info := 'REQUIRED';
         lv_message :=
            lv_message || ' : ' || G\$_NLS.Get ('BWGKPXYA1-0001', 'SQL', 'First Name');
      END IF;

      -- Check last name (always required)
      IF goksels.f_clean_text(p_last_name) IS NULL
      THEN
         lv_info := 'REQUIRED';
         lv_message :=
            lv_message || ' : ' || G\$_NLS.Get ('BWGKPXYA1-0002', 'SQL', 'Last Name');
      END IF;

      -- Check e-mail address (always required)
      IF goksels.f_clean_text(p_email_address) IS NULL
      THEN
         lv_info := 'REQUIRED';
         lv_message :=
            lv_message || ' : ' || G\$_NLS.Get ('BWGKPXYA1-0003', 'SQL', 'E-Mail Address');
      END IF;

      -- Check name prefix (salutation)
      P_Check_If_Missing('PROFILE_NAME_PREFIX',     p_name_prefix,     G\$_NLS.Get ('BWGKPXYA1-0004', 'SQL', 'Salutation'));
      -- Check middle name
      P_Check_If_Missing('PROFILE_MI',              p_mi,              G\$_NLS.Get ('BWGKPXYA1-0005', 'SQL', 'Middle Name'));
      -- Check surname prefix
      P_Check_If_Missing('PROFILE_SURNAME_PREFIX',  p_surname_prefix,  G\$_NLS.Get ('BWGKPXYA1-0006', 'SQL', 'Surname Prefix'));
      -- Check name suffix
      P_Check_If_Missing('PROFILE_NAME_SUFFIX',     p_name_suffix,     G\$_NLS.Get ('BWGKPXYA1-0007', 'SQL', 'Name Suffix'));
      -- Check preferred first name (nickname)
      P_Check_If_Missing('PROFILE_PREF_FIRST_NAME', p_pref_first_name, G\$_NLS.Get ('BWGKPXYA1-0008', 'SQL', 'Nickname'));
      -- Check phone area code
      P_Check_If_Missing('PROFILE_PHONE_AREA',      p_phone_area,      G\$_NLS.Get ('BWGKPXYA1-0009', 'SQL', 'Phone Area Code'));
      -- Check phone number
      P_Check_If_Missing('PROFILE_PHONE_NUMBER',    p_phone_number,    G\$_NLS.Get ('BWGKPXYA1-0010', 'SQL', 'Phone Number'));
      -- Check phone extension
      P_Check_If_Missing('PROFILE_PHONE_EXT',       p_phone_ext,       G\$_NLS.Get ('BWGKPXYA1-0011', 'SQL', 'Phone Extension'));
      -- Check phone country code
      P_Check_If_Missing('PROFILE_PHONE_COUNTRY',   p_ctry_code_phone, G\$_NLS.Get ('BWGKPXYA1-0012', 'SQL', 'Phone Country Code'));
      -- Check house number
      P_Check_If_Missing('PROFILE_HOUSE_NUMBER',    p_house_number,    G\$_NLS.Get ('BWGKPXYA1-0013', 'SQL', 'House Number'));
      -- Check address line 1
      P_Check_If_Missing('PROFILE_STREET_LINE1',    p_street_line1,    G\$_NLS.Get ('BWGKPXYA1-0014', 'SQL', 'Address Line 1'));
      -- Check address line 2
      P_Check_If_Missing('PROFILE_STREET_LINE2',    p_street_line2,    G\$_NLS.Get ('BWGKPXYA1-0015', 'SQL', 'Address Line 2'));
      -- Check address line 3
      P_Check_If_Missing('PROFILE_STREET_LINE3',    p_street_line3,    G\$_NLS.Get ('BWGKPXYA1-0016', 'SQL', 'Address Line 3'));
      -- Check address line 4
      P_Check_If_Missing('PROFILE_STREET_LINE4',    p_street_line4,    G\$_NLS.Get ('BWGKPXYA1-0017', 'SQL', 'Address Line 4'));
      -- Check city
      P_Check_If_Missing('PROFILE_CITY',            p_city,            G\$_NLS.Get ('BWGKPXYA1-0018', 'SQL', 'City'));
      -- Check state
      P_Check_If_Missing('PROFILE_STAT_CODE',       p_stat_code,       G\$_NLS.Get ('BWGKPXYA1-0019', 'SQL', 'State'));
      -- Check zipcode
      P_Check_If_Missing('PROFILE_ZIP',             p_zip,             G\$_NLS.Get ('BWGKPXYA1-0020', 'SQL', 'Zipcode'));
      -- Check county
      P_Check_If_Missing('PROFILE_CNTY_CODE',       p_cnty_code,       G\$_NLS.Get ('BWGKPXYA1-0021', 'SQL', 'County'));
      -- Check nation
      P_Check_If_Missing('PROFILE_NATN_CODE',       p_natn_code,       G\$_NLS.Get ('BWGKPXYA1-0022', 'SQL', 'Nation'));
      -- Check gender
      P_Check_If_Missing('PROFILE_SEX',             p_sex,             G\$_NLS.Get ('BWGKPXYA1-0023', 'SQL', 'Gender'));
      -- Check national identifier
      P_Check_If_Missing('PROFILE_SSN',             p_ssn,             G\$_NLS.Get ('BWGKPXYA1-0024', 'SQL', 'SSN/SIN/TIN'));
      -- Check birth date
      P_Check_If_Missing('PROFILE_BIRTH_DATE',      p_birth_date,      G\$_NLS.Get ('BWGKPXYA1-0025', 'SQL', 'Birthdate'));
      -- Also check validity of date
      IF p_birth_date IS NOT NULL THEN
        IF f_validate_date(p_birth_date) IS NULL THEN
          lv_info := 'REQUIRED';
          lv_message :=
            lv_message || ' : ' || g\$_nls.get ('BWGKPXYA1-0026', 'SQL', 'Birthdate %01% has invalid date format or values.' ,p_birth_date);
         END IF;
      END IF;

      IF lv_info <> 'REQUIRED'
      THEN
         lv_message := NULL;
      END IF;

      RETURN lv_message;

   END f_find_missing_data;

   BEGIN

   lv_message := f_find_missing_data(
                         p_proxy_idm        => ?,
                         p_first_name       => ?,
                         p_mi               => ?,
                         p_last_name        => ?,
                         p_surname_prefix   => ?,
                         p_name_prefix      => ?,
                         p_name_suffix      => ?,
                         p_pref_first_name  => ?,
                         p_email_address    => ?,
                         p_phone_area       => ?,
                         p_phone_number     => ?,
                         p_phone_ext        => ?,
                         p_ctry_code_phone  => ?,
                         p_house_number     => ?,
                         p_street_line1     => ?,
                         p_street_line2     => ?,
                         p_street_line3     => ?,
                         p_street_line4     => ?,
                         p_city             => ?,
                         p_stat_code        => ?,
                         p_zip              => ?,
                         p_cnty_code        => ?,
                         p_natn_code        => ?,
                         p_sex              => ?,
                         p_birth_date       => ?,
                         p_ssn              => ?);

      ? := lv_message;

   END;
    """
}

getStudentListForProxy {
    sqlText = """
DECLARE
  lv_attr_nt     G_ATTRIBUTE_NT;
  lv_minify_ext  varchar2(04);

  CURSOR C_PersonList RETURN GPRXREF%ROWTYPE
      IS
           SELECT GPRXREF.*
             FROM GPRXREF
            WHERE GPRXREF_PROXY_IDM = ?
                  AND TRUNC (SYSDATE) BETWEEN TRUNC (GPRXREF_START_DATE)
                                          AND TRUNC (GPRXREF_STOP_DATE)
         ORDER BY F_Format_Name (GPRXREF_PERSON_PIDM, 'LFMI');

 students varchar2(3000);

BEGIN

      -- Loop through potential Banner Web users
      -- Only show users if they have the Proxy Management role

  students := '{ "students":[';

      FOR person IN C_PersonList
      LOOP
         -- Execute the GORRSQL rule for proxy management
         -- Only create tab for first occurance of role
         lv_attr_nt :=
            gp_gorrsql.F_Execute_Rule ('SSB_ROLES',
                                       'SSB_ROLE_PROXYMGMT',
                                       person.GPRXREF_PERSON_PIDM);

         IF lv_attr_nt IS NOT NULL AND lv_attr_nt.COUNT > 0
         THEN
            FOR i IN lv_attr_nt.FIRST .. lv_attr_nt.LAST
            LOOP
               IF lv_attr_nt (i)."value" = 'TRUE'
               THEN

                      students := students || '{' ||
                      '"name" ' || ':' || '"' || f_format_name (person.GPRXREF_PERSON_PIDM, 'FML') || '"' ||
                      ',"pidm" ' || ':'  || person.GPRXREF_PERSON_PIDM || '},';
                  END IF;
            END LOOP;

         END IF;
      END LOOP;

     students := TRIM(TRAILING ',' FROM students );

     students := students || ']}';

     ? := students;

END;
    """
}

getProxyPages {
    sqlText = """
DECLARE
  CURSOR C_AuthorizationList (
      p_RETP gprxref.gprxref_retp_code%TYPE)
   IS
        SELECT m.twgbwmnu_name     AS menu_name,
               m.twgbwmnu_desc     AS menu_desc,
               o.twgrmenu_url_text AS menu_text,
               o.twgrmenu_url      AS menu_url,
               o.twgrmenu_sequence AS menu_seq
          FROM TWGRMENU o, TWGBWMNU m
         WHERE o.twgrmenu_name = m.twgbwmnu_name
         AND  o.twgrmenu_url like '%/proxy/%'
           AND m.twgbwmnu_source_ind =
              (SELECT NVL (MAX (n.twgbwmnu_source_ind), 'B')
                 FROM twgbwmnu n
                WHERE n.twgbwmnu_name = m.twgbwmnu_name
                  AND n.twgbwmnu_source_ind = 'L')
           AND o.twgrmenu_source_ind =
              (SELECT NVL (MAX (p.twgrmenu_source_ind), 'B')
                 FROM twgrmenu p
                WHERE p.twgrmenu_name = o.twgrmenu_name
                  AND p.twgrmenu_source_ind = 'L')
           AND o.twgrmenu_name LIKE 'PROXY_ACCESS_' || p_RETP || '%'
           AND NVL(o.twgrmenu_enabled, 'N')       = 'Y'
           AND NVL(m.twgbwmnu_enabled_ind,'N')    = 'Y'
           AND NVL(m.twgbwmnu_adm_access_ind,'N') = 'N'
           AND NVL(o.twgrmenu_enabled,'N')        = 'Y'
      ORDER BY menu_desc, menu_name, menu_seq;

lv_RETP        gtvretp.gtvretp_code%TYPE;
pages          VARCHAR2(32000);

BEGIN
--
pages:= '{ "pages":[';
--
lv_RETP := gp_gprxref.F_GetXREF_RETP (?, ?);
--
FOR auth_rec IN C_AuthorizationList (lv_RETP)
--
      LOOP
         -- Only show page link if it is authorized and is valid for the person
         IF bwgkprxy.F_GetAuthInd (?,
                                   ?,
                                   auth_rec.menu_url) = 'Y'
            --AND twbkwbis.F_ValidLink (auth_rec.menu_url)
         THEN
            pages := pages || '{' ||
                      '"url" ' || ':' || '"' || auth_rec.menu_url || '"' ||
                      ',"desc" ' || ':'  || '"' || auth_rec.menu_text || '"' || '},';
      END IF;
    END LOOP;
--
     pages := TRIM(TRAILING ',' FROM pages );
--
     pages := pages || ']}';

     ? := pages;
--
END;
    """
}

getWeeklyCourseSchedule {
    sqlText = """
--
-- P_CRSESCHD.
-- Displays the Week at a glance page.
-- ==================================================
--   PROCEDURE P_CrseSchd (
--      start_date_in   IN   VARCHAR2 DEFAULT NULL,
--      error_msg_in    IN   VARCHAR2 DEFAULT NULL,
--      error_date_in   IN   VARCHAR2 DEFAULT NULL
--   )
--   IS
declare
--
-- Cursor to read meeting records.
-- ==================================================
      CURSOR sfvstumc (
         pidm_in         NUMBER,
         start_date_in   DATE DEFAULT NULL,
         end_date_in     DATE DEFAULT NULL
      )
      IS
         SELECT SFRSTCR.SFRSTCR_TERM_CODE term_code,
                SSBSECT.SSBSECT_CRN crn,
                SSBSECT.SSBSECT_SUBJ_CODE subj_code,
                SSBSECT.SSBSECT_CRSE_NUMB crse_numb,
                SSBSECT.SSBSECT_SEQ_NUMB seq_numb,
                SSRMEET.SSRMEET_MON_DAY mon_day,
                SSRMEET.SSRMEET_TUE_DAY tue_day,
                SSRMEET.SSRMEET_WED_DAY wed_day,
                SSRMEET.SSRMEET_THU_DAY thu_day,
                SSRMEET.SSRMEET_FRI_DAY fri_day,
                SSRMEET.SSRMEET_SAT_DAY sat_day,
                SSRMEET.SSRMEET_SUN_DAY sun_day, SSRMEET.SSRMEET_START_DATE,
                SSRMEET.SSRMEET_END_DATE,
                SSBSECT.SSBSECT_PTRM_START_DATE,
                SSBSECT.SSBSECT_PTRM_END_DATE,
                SSRMEET.SSRMEET_BEGIN_TIME begin_time,
                SSRMEET.SSRMEET_END_TIME end_time,
                SSRMEET.SSRMEET_BLDG_CODE bldg_code,
                SSRMEET.SSRMEET_ROOM_CODE room_code,
                SSRMEET.SSRMEET_MTYP_CODE mtyp_code, NULL gtvmtyp_desc
           FROM SSRMEET, SSBSECT, SFRSTCR, STVRSTS, SOBTERM
          WHERE SSBSECT.SSBSECT_TERM_CODE = SFRSTCR.SFRSTCR_TERM_CODE
            AND SSBSECT.SSBSECT_CRN = SFRSTCR.SFRSTCR_CRN
            AND SFRSTCR_RSTS_CODE = STVRSTS_CODE
            AND STVRSTS_SB_PRINT_IND = 'Y'
            AND STVRSTS_WAIT_IND = 'N'
            AND STVRSTS_WITHDRAW_IND = 'N'
            AND SSRMEET.SSRMEET_TERM_CODE = SFRSTCR.SFRSTCR_TERM_CODE
            AND SSRMEET.SSRMEET_CRN = SFRSTCR.SFRSTCR_CRN
            AND (
                      (
                             SFRSTCR.SFRSTCR_ERROR_FLAG <> 'D'
                         AND SFRSTCR.SFRSTCR_ERROR_FLAG <> 'F'
                      )
                   OR SFRSTCR.SFRSTCR_ERROR_FLAG IS NULL
                )
            AND SFRSTCR.SFRSTCR_PIDM = pidm_in
            AND SFRSTCR.SFRSTCR_TERM_CODE = sobterm_term_code
            AND (
                      SSRMEET.SSRMEET_START_DATE BETWEEN start_date_in
                          AND end_date_in
                   OR SSRMEET.SSRMEET_END_DATE BETWEEN start_date_in
                          AND end_date_in
                   OR start_date_in BETWEEN SSRMEET.SSRMEET_START_DATE
                          AND SSRMEET.SSRMEET_END_DATE
                   OR end_date_in BETWEEN SSRMEET.SSRMEET_START_DATE
                          AND SSRMEET.SSRMEET_END_DATE
                )
            AND SSRMEET.SSRMEET_BEGIN_TIME IS NOT NULL
            AND SSRMEET.SSRMEET_END_TIME IS NOT NULL
            AND (
                      SSRMEET.SSRMEET_MON_DAY IS NOT NULL
                   OR SSRMEET.SSRMEET_TUE_DAY IS NOT NULL
                   OR SSRMEET.SSRMEET_WED_DAY IS NOT NULL
                   OR SSRMEET.SSRMEET_THU_DAY IS NOT NULL
                   OR SSRMEET.SSRMEET_FRI_DAY IS NOT NULL
                   OR SSRMEET.SSRMEET_SAT_DAY IS NOT NULL
                   OR SSRMEET.SSRMEET_SUN_DAY IS NOT NULL
                )
            AND sobterm_dynamic_sched_term_ind = 'Y'
          ORDER BY SSRMEET.SSRMEET_BEGIN_TIME,
                   SSRMEET.SSRMEET_END_TIME,
                   SSRMEET.SSRMEET_MON_DAY,
                   SSRMEET.SSRMEET_TUE_DAY,
                   SSRMEET.SSRMEET_WED_DAY,
                   SSRMEET.SSRMEET_THU_DAY,
                   SSRMEET.SSRMEET_FRI_DAY,
                   SSRMEET.SSRMEET_SAT_DAY,
                   SSRMEET.SSRMEET_SUN_DAY;

      CURSOR sfvstareg (
         pidm_in         NUMBER,
         term_in         VARCHAR2,
         crn_in          VARCHAR2
      )
      IS
         SELECT SFRAREG_START_DATE,
                SFRAREG_COMPLETION_DATE
           FROM SFRAREG
          WHERE SFRAREG_PIDM = pidm_in
            AND SFRAREG_CRN = crn_in
            AND SFRAREG_TERM_CODE = term_in
            AND (
                      EXISTS (SELECT 'X'
                                FROM STVRSTS B
                               WHERE B.STVRSTS_CODE = SFRAREG_RSTS_CODE
                                 AND B.STVRSTS_WITHDRAW_IND = 'N')
                   OR NOT EXISTS (SELECT 'Y'
                                    FROM STVRSTS C
                                   WHERE C.STVRSTS_CODE = SFRAREG_RSTS_CODE)
                );

      sfvstareg_rec sfvstareg%ROWTYPE;

--
-- Classes that do not have meeting times in the current
-- template.
-- ==================================================
      CURSOR nonschdc (
         pidm_in         NUMBER
      )
      IS
         SELECT DISTINCT ssbsect_subj_code subj_code,
                         ssbsect_crse_numb crse_numb,
                         ssbsect_seq_numb seq_numb, sfrstcr_crn crn,
                         sfrstcr_term_code term_code, stvschd_desc,
                         ssbsect_ptrm_code ptrm_code,
                         ssbsect_ptrm_start_date,
                         ssbsect_ptrm_end_date
           FROM ssbsect, sfrstcr, stvrsts, sobterm, stvschd
          WHERE sfrstcr_pidm = pidm_in
            AND sfrstcr_term_code = sobterm_term_code
            AND ssbsect_term_code = sfrstcr_term_code
            AND NVL(sfrstcr_error_flag,'N') <> 'F'
            AND ssbsect_crn = sfrstcr_crn
            AND (
                      NOT EXISTS (SELECT 1
                                    FROM ssrmeet
                                   WHERE ssrmeet_crn = sfrstcr_crn
                                     AND ssrmeet_term_code = sfrstcr_term_code)
                   OR EXISTS (SELECT 1
                                FROM ssrmeet
                               WHERE ssrmeet_crn = sfrstcr_crn
                                 AND ssrmeet_term_code = sfrstcr_term_code
                                 AND ssrmeet_mon_day IS NULL
                                 AND ssrmeet_tue_day IS NULL
                                 AND ssrmeet_wed_day IS NULL
                                 AND ssrmeet_thu_day IS NULL
                                 AND ssrmeet_fri_day IS NULL
                                 AND ssrmeet_sat_day IS NULL
                                 AND ssrmeet_sun_day IS NULL
                                 AND ssrmeet_begin_time IS NULL
                                 AND ssrmeet_end_time IS NULL)
                )
            AND ssbsect_schd_code = stvschd_code
            AND stvrsts_code = sfrstcr_rsts_code
            AND stvrsts_sb_print_ind = 'Y'
            AND stvrsts_wait_ind = 'N'
            AND stvrsts_withdraw_ind = 'N'
            AND sobterm_dynamic_sched_term_ind = 'Y';

      CURSOR gtvmtypc (mtyp_code_in VARCHAR2)
      IS
         SELECT gtvmtyp_desc
           FROM gtvmtyp
          WHERE gtvmtyp_code = mtyp_code_in;

--
-- Tables.
-- ==================================================
      meeting_tab              bwckweek.meeting_tab_type;
      template_tab             bwckweek.template_tab_type;
--
-- Variables/Constants.
-- ==================================================
      row_count                INTEGER;
      min_time                 VARCHAR2 (4);
      max_time                 VARCHAR2 (4);
      template_start_date      DATE;
      template_end_date        DATE;
      no_schd                  BOOLEAN                    := TRUE;
      slots_in_hour   CONSTANT INTEGER                    := 4;
      slot_length     CONSTANT INTEGER                    := 60 /
                                                                slots_in_hour;
      template_index           INTEGER;
      --
      todays_template_index    INTEGER                    := 0;
      max_template_index       INTEGER                    := 0;
      start_date               DATE;
      i_date                   DATE;
      s_date                   DATE;
      e_date                   DATE;

      start_date_in            VARCHAR2 (30) := ?;
      lv_pidm                  INTEGER  := ?;
      lv_sched_json            VARCHAR2 (32000) DEFAULT NULL;
      lv_tba_sched_json        VARCHAR2 (32000) DEFAULT NULL;
      lv_errorMsg              VARCHAR2 (30) DEFAULT NULL;
      lv_temp_fmt              VARCHAR2 (30);
      lv_has_prev_wk           VARCHAR2(6) := 'false';
      lv_has_next_wk           VARCHAR2(6) := 'false';
   BEGIN

   -- Validate CHAR/VARCHAR2 post variables
--    twbksecr.p_chk_parms_05(start_date_in, error_msg_in, error_date_in); /*080701-1*/

-- Check for valid user.
-- ==================================================
--      IF NOT twbkwbis.f_validuser (global_pidm)
--      THEN
--         RETURN;
--      END IF;

--
-- Start the web page.
-- ==================================================
--      bwckfrmt.p_open_doc ('bwskfshd.P_CrseSchd');
--
-- Display info text.
-- ==================================================
--      twbkwbis.p_dispinfo ('bwskfshd.P_CrseSchd', 'DEFAULT');
--
-- Populate a pl/sql table with the start and end dates
-- for each template. A template is a frame of time when the
-- user's schedule remains static. A template starts on the
-- week that a class starts or the week after a class ends.
-- The template end dates can be derived as one week before
-- the start dates.
-- ==================================================
      lv_temp_fmt := twbklibs.date_input_fmt;
      twbklibs.date_input_fmt := 'MM/DD/YYYY';

      bwckweek.p_load_template (
         'S',
         lv_pidm,
         start_date_in,
         start_date,
         i_date,
         template_index,
         template_tab,
         template_start_date,
         template_end_date,
         todays_template_index,
         no_schd,
         max_template_index
      );

      twbklibs.date_input_fmt := lv_temp_fmt;

--
-- Loop through schedule records for the current template.
-- ==================================================
      row_count := 0;

      lv_sched_json := '{"schedStartDate":"' || to_char(template_start_date, 'MM/DD/YYYY') || '", ';
      lv_sched_json := lv_sched_json || '"schedEndDate":"' || to_char(template_end_date, 'MM/DD/YYYY') || '", ';
      lv_sched_json := lv_sched_json || '"rows": [';


      <<read_classes_loop>>
      FOR sfvstum_rec IN sfvstumc (
                            lv_pidm,
                            template_start_date,
                            template_end_date
                         )
      LOOP
         OPEN sfvstareg (lv_pidm,
                         sfvstum_rec.term_code,
                         sfvstum_rec.crn);
         FETCH sfvstareg INTO sfvstareg_rec;
         CLOSE sfvstareg;

         -- Determine the intersect dates (SFRAREG vs. SSRMEET)
         IF GREATEST (
               NVL (sfvstum_rec.ssrmeet_start_date, SYSDATE - 36500),
               NVL (NVL(sfvstareg_rec.sfrareg_start_date, sfvstum_rec.ssbsect_ptrm_start_date), SYSDATE - 36500)
            ) > NVL (NVL(sfvstareg_rec.sfrareg_completion_date, sfvstum_rec.ssbsect_ptrm_end_date), SYSDATE + 36500)
         THEN
            s_date := NVL(sfvstareg_rec.sfrareg_start_date, sfvstum_rec.ssbsect_ptrm_start_date);
         ELSE
            s_date :=
              GREATEST (
                 NVL (sfvstum_rec.ssrmeet_start_date, SYSDATE - 36500),
                 NVL (NVL(sfvstareg_rec.sfrareg_start_date, sfvstum_rec.ssbsect_ptrm_start_date), SYSDATE - 36500)
              );
         END IF;

         IF LEAST (
               NVL (sfvstum_rec.ssrmeet_end_date, SYSDATE + 36500),
               NVL (NVL (sfvstareg_rec.sfrareg_completion_date, sfvstum_rec.ssbsect_ptrm_end_date), SYSDATE + 36500)
            ) < NVL (NVL(sfvstareg_rec.sfrareg_start_date, sfvstum_rec.ssbsect_ptrm_start_date), SYSDATE - 36500)
         THEN
            e_date := NVL (sfvstareg_rec.sfrareg_completion_date, sfvstum_rec.ssbsect_ptrm_end_date);
         ELSE
            e_date :=
              LEAST (
                 NVL (sfvstum_rec.ssrmeet_end_date, SYSDATE + 36500),
                 NVL (NVL (sfvstareg_rec.sfrareg_completion_date, sfvstum_rec.ssbsect_ptrm_end_date), SYSDATE + 36500)
              );
         END IF;

         -- If the template dates dont fall within the intersect dates,
         -- ignore this class record
         IF NOT (
                      s_date BETWEEN template_start_date AND template_end_date
                   OR e_date BETWEEN template_start_date AND template_end_date
                   OR template_start_date BETWEEN s_date AND e_date
                   OR template_end_date BETWEEN s_date AND e_date
                )
         THEN
            GOTO end_loop;
         END IF;

         row_count := row_count + 1;

         IF row_count = 1
         THEN
            lv_sched_json := lv_sched_json || '{';
         ELSE
            lv_sched_json := lv_sched_json || ', {';
         END IF;


--
-- Keep track of the earliest and latest times for the
-- current template for purposes of determining length
-- of html table.
-- ==================================================
         min_time :=
           LEAST (
              NVL (min_time, sfvstum_rec.begin_time),
              sfvstum_rec.begin_time
           );
         max_time :=
           GREATEST (
              NVL (max_time, sfvstum_rec.end_time),
              sfvstum_rec.end_time
           );
         min_time := bwckweek.f_time_slot_round (min_time, slot_length);
         max_time := bwckweek.f_time_slot_round (max_time, slot_length);
--
-- Put the class record into an array.
-- ==================================================
         meeting_tab (row_count) := sfvstum_rec;
         -- Use the intersect dates for creating the weekly grid
         meeting_tab (row_count).ssrmeet_start_date := s_date;
         meeting_tab (row_count).ssrmeet_end_date := e_date;
         OPEN gtvmtypc (sfvstum_rec.mtyp_code);
         FETCH gtvmtypc INTO meeting_tab (row_count).gtvmtyp_desc;
         CLOSE gtvmtypc;

         lv_sched_json := lv_sched_json || '"meeting_term_code": "' || meeting_tab (row_count).term_code || '",';
         lv_sched_json := lv_sched_json || '"meeting_crn": "' || meeting_tab (row_count).crn || '",';
         lv_sched_json := lv_sched_json || '"meeting_subj_code": "' || meeting_tab (row_count).subj_code || '",';
         lv_sched_json := lv_sched_json || '"meeting_crse_numb": "' || meeting_tab (row_count).crse_numb || '",';
         lv_sched_json := lv_sched_json || '"meeting_seq_numb": "' || meeting_tab (row_count).seq_numb || '",';
         lv_sched_json := lv_sched_json || '"meeting_mon_day": "' || meeting_tab (row_count).mon_day || '",';
         lv_sched_json := lv_sched_json || '"meeting_tue_day": "' || meeting_tab (row_count).tue_day || '",';
         lv_sched_json := lv_sched_json || '"meeting_wed_day": "' || meeting_tab (row_count).wed_day || '",';
         lv_sched_json := lv_sched_json || '"meeting_thu_day": "' || meeting_tab (row_count).thu_day || '",';
         lv_sched_json := lv_sched_json || '"meeting_fri_day": "' || meeting_tab (row_count).fri_day || '",';
         lv_sched_json := lv_sched_json || '"meeting_sat_day": "' || meeting_tab (row_count).sat_day || '",';
         lv_sched_json := lv_sched_json || '"meeting_sun_day": "' || meeting_tab (row_count).sun_day || '",';
         lv_sched_json := lv_sched_json || '"meeting_ssrmeet_start_date": "' || to_char(meeting_tab (row_count).ssrmeet_start_date,'MM/DD/YYYY') || '",';
         lv_sched_json := lv_sched_json || '"meeting_ssrmeet_end_date": "' || to_char(meeting_tab (row_count).ssrmeet_end_date,'MM/DD/YYYY') || '",';
         lv_sched_json := lv_sched_json || '"meeting_sfrareg_start_date": "' || meeting_tab (row_count).sfrareg_start_date || '",';
         lv_sched_json := lv_sched_json || '"meeting_sfrareg_completion_date": "' || meeting_tab (row_count).sfrareg_completion_date || '",';
         lv_sched_json := lv_sched_json || '"meeting_begin_time": "' || meeting_tab (row_count).begin_time || '",';
         lv_sched_json := lv_sched_json || '"meeting_end_time": "' || meeting_tab (row_count).end_time || '",';
         lv_sched_json := lv_sched_json || '"meeting_bldg_code": "' || meeting_tab (row_count).bldg_code || '",';
         lv_sched_json := lv_sched_json || '"meeting_room_code": "' || meeting_tab (row_count).room_code || '",';
         lv_sched_json := lv_sched_json || '"meeting_mtyp_code": "' || meeting_tab (row_count).mtyp_code || '",';
         lv_sched_json := lv_sched_json || '"meeting_gtvmtyp_code": "' || meeting_tab (row_count).gtvmtyp_desc || '",';


         lv_sched_json := lv_sched_json || '}';

         <<end_loop>>
         NULL;
      END LOOP read_classes_loop;

--
-- Display any error messages, and the go to date input field.
-- ===========================================================
--      bwckweek.p_goto_date (
--         error_msg_in,
--         error_date_in,
--         start_date,
--         'bwskfshd.p_proc_crse_schd'
--      );
--
-- Display the Weekly schedule table
-- ==================================================
--      bwckweek.p_disp_grid (
--         meeting_tab,
--         template_tab,
--         max_template_index,
--         todays_template_index,
--         template_start_date,
--         'bwskfshd.P_CrseSchd',
--         'bwskfshd.P_CrseSchdDetl',
--         slots_in_hour,
--         slot_length,
--         min_time,
--         max_time,
--         row_count,
--         no_schd
--      );
      IF todays_template_index > 1
      THEN
         lv_has_prev_wk := 'true';
      END IF;
      --lv_has_prev_wk := todays_template_index > 1;
      IF todays_template_index < max_template_index
      THEN
         lv_has_next_wk := 'true';
      END IF;
      --lv_has_next_wk := todays_template_index < max_template_index;
      lv_sched_json := lv_sched_json || '],"hasNextWeek":' || lv_has_next_wk || ',';
      lv_sched_json := lv_sched_json || '"hasPrevWeek":' || lv_has_prev_wk;
      lv_sched_json := lv_sched_json || '}';

--
-- Print classes without assigned times.
-- ==================================================
      lv_tba_sched_json := '{"rows": [';
      row_count := 0;

      <<print_nonscheduled_loop>>
      FOR crse_rec IN nonschdc (lv_pidm)
      LOOP
         OPEN sfvstareg (lv_pidm,
         		          crse_rec.term_code,
         			       crse_rec.crn);
         FETCH sfvstareg INTO sfvstareg_rec;
         CLOSE sfvstareg;

         -- If the template dates dont fall within the intersect dates,
         -- ignore this class record
         IF NOT (
                   (  template_start_date
                      BETWEEN NVL (sfvstareg_rec.sfrareg_start_date,
                                   crse_rec.ssbsect_ptrm_start_date)
                          AND NVL (sfvstareg_rec.sfrareg_completion_date,
                                   crse_rec.ssbsect_ptrm_end_date)
                   )
                OR (  template_end_date
                      BETWEEN NVL (sfvstareg_rec.sfrareg_start_date,
                                   crse_rec.ssbsect_ptrm_start_date)
                          AND NVL (sfvstareg_rec.sfrareg_completion_date,
                                   crse_rec.ssbsect_ptrm_end_date)
                   )
                OR (  NVL (sfvstareg_rec.sfrareg_start_date, crse_rec.ssbsect_ptrm_start_date)
                      BETWEEN template_start_date
                          AND template_end_date
                   )
                OR (  NVL (sfvstareg_rec.sfrareg_completion_date, crse_rec.ssbsect_ptrm_end_date)
                      BETWEEN template_start_date
                          AND template_end_date
                   )
                )
         THEN
            GOTO end_ns_loop;
         END IF;

         row_count := row_count + 1;

--         bwckweek.p_disp_unassigned (
--            crse_rec.term_code,
--            crse_rec.crn,
--            crse_rec.subj_code,
--            crse_rec.crse_numb,
--            crse_rec.seq_numb,
--           crse_rec.ptrm_code,
--            crse_rec.stvschd_desc,
--            'bwskfshd.P_CrseSchdDetl',
--            row_count
--         );
         IF row_count = 1
         THEN
            lv_tba_sched_json := lv_tba_sched_json || '{';
         ELSE
            lv_tba_sched_json := lv_tba_sched_json || ', {';
         END IF;
         lv_tba_sched_json := lv_tba_sched_json || '"crse_term_code": "' || crse_rec.term_code || '",';
         lv_tba_sched_json := lv_tba_sched_json || '"crse_crn": "' || crse_rec.crn || '",';
         lv_tba_sched_json := lv_tba_sched_json || '"crse_subj_code": "' || crse_rec.subj_code || '",';
         lv_tba_sched_json := lv_tba_sched_json || '"crse_crse_numb": "' || crse_rec.crse_numb || '",';
         lv_tba_sched_json := lv_tba_sched_json || '"crse_seq_numb": "' || crse_rec.seq_numb || '",';
         lv_tba_sched_json := lv_tba_sched_json || '"crse_ptrm_code": "' || crse_rec.ptrm_code || '",';
         lv_tba_sched_json := lv_tba_sched_json || '"crse_stvschd_desc": "' || crse_rec.stvschd_desc || '"';
         lv_tba_sched_json := lv_tba_sched_json || '}';

         <<end_ns_loop>>
         NULL;

      END LOOP print_nonscheduled_loop;
      lv_tba_sched_json := lv_tba_sched_json || ']}';


      IF row_count > 0
      THEN
         no_schd := FALSE;
      END IF;

--
-- Handle no schedule.
-- ==================================================
      IF no_schd
      THEN
--         twbkfrmt.p_printmessage (
--            G$_NLS.Get ('BWSKFSH1-0000',
--              'SQL',
--               'You are not currently registered'
--            ),
--            'ERROR'
--         );
         lv_errorMsg := 'notRegistered';
      END IF;

--
-- Close out.
-- ==================================================
--      HTP.br;
--      twbkwbis.p_closedoc (curr_release);
--   END P_CrseSchd;

   ? := lv_sched_json;
   ? := lv_tba_sched_json;
   ? := lv_errorMsg;
END;
    """
}

getCourseScheduleDetail {
    sqlText = """
DECLARE
   row_count                NUMBER;
   scbcrse_row              scbcrse%ROWTYPE;
   name1                    VARCHAR2 (60);
   cpinuse                  VARCHAR2 (1);
   webctinuse               VARCHAR2 (1);
   makewebctlink            VARCHAR2 (1);
   webctlogin               VARCHAR2 (200);
   webctlink                VARCHAR2 (1000);
   tot_credit_hr            NUMBER;
   tot_bill_hr              NUMBER;
   tot_ceu                  NUMBER;
   term                     stvterm.stvterm_code%TYPE;
   hold_beg_time            VARCHAR2 (30);
   hold_end_time            VARCHAR2 (30);
   not_registered_message   VARCHAR2 (60);
   genpidm                  spriden.spriden_pidm%TYPE;
   table_opened             BOOLEAN                   := FALSE;
   hld_stvgmod_desc         STVGMOD.STVGMOD_DESC%TYPE;
   hld_stvlevl_desc         STVLEVL.STVLEVL_DESC%TYPE;
   call_path                VARCHAR2 (1);
   lv_wl_notification_ref   sb_wl_notification.wl_notification_ref;
   lv_wl_notification_rec   sb_wl_notification.wl_notification_rec;
   lv_wl_section_ctrl_ref   sb_wl_section_ctrl.wl_section_ctrl_ref;
   lv_wl_section_ctrl_rec   sb_wl_section_ctrl.wl_section_ctrl_rec;
   -- 8.4.0.2 HEOA. Two New Variables.
   lv_page_in               CONSTANT VARCHAR2(4) := 'SCHD';
   lv_int_url_txt           VARCHAR2(100) := 'Bookstore';

--  BWCKGEN globals
   tmp_hist_ind            VARCHAR2 (1)                           DEFAULT NULL;
   stvterm_rec             stvterm%ROWTYPE;
   sorrtrm_rec             sorrtrm%ROWTYPE;

-- p_disp_meeting_times
   pdm_term_in   stvterm.stvterm_code%TYPE;
   pdm_crn_in    ssbsect.ssbsect_crn%TYPE;

   meeting_times_found   BOOLEAN        := FALSE;
   instr_name            VARCHAR2 (3000);
   hold_instr_name       VARCHAR2 (3000);
   temp_instr_name       VARCHAR2 (3000);
   pdm_hold_beg_time         VARCHAR2 (30);
   pdm_hold_end_time         VARCHAR2 (30);
   primary_ind           VARCHAR2 (50);
-- p_disp_meeting_times

   CURSOR regcrsec (
      pidm_in       spriden.spriden_pidm%TYPE,
      term_in       stvterm.stvterm_code%TYPE DEFAULT NULL,
      crn_in        ssbsect.ssbsect_crn%TYPE DEFAULT NULL,
      hist_ind_in   VARCHAR2 DEFAULT NULL
   )
   IS
      SELECT *
        FROM stvschd,
             stvcamp,
             stvrsts,
             ssbsect,
             sfrstcr,
             stvterm,
             scbcrse,
             sobterm
       WHERE sfrstcr_term_code = sobterm_term_code
         AND sobterm_dynamic_sched_term_ind = 'Y'
         AND sfrstcr_pidm = pidm_in
         AND sfrstcr_term_code = NVL (term_in, sfrstcr_term_code)
         AND sfrstcr_crn = NVL (crn_in, sfrstcr_crn)
         AND sfrstcr_crn = ssbsect_crn
         AND NVL(sfrstcr_error_flag,'N') <> 'F'
         AND ssbsect_term_code = sfrstcr_term_code
         AND scbcrse_subj_code = ssbsect_subj_code
         AND scbcrse_crse_numb = ssbsect_crse_numb
         AND scbcrse_eff_term =
              (SELECT MAX (scbcrse_eff_term)
                 FROM scbcrse x
                WHERE x.scbcrse_subj_code = ssbsect_subj_code
                  AND x.scbcrse_crse_numb = ssbsect_crse_numb
                  AND x.scbcrse_eff_term <= sfrstcr_term_code)
         AND stvcamp_code = sfrstcr_camp_code
         AND stvschd_code = ssbsect_schd_code
         AND stvrsts_code = sfrstcr_rsts_code
         AND stvterm_code = sfrstcr_term_code
         AND stvrsts_sb_print_ind =
                            DECODE (hist_ind_in, 'Y', stvrsts_sb_print_ind, 'Y')
       ORDER BY ssbsect_term_code DESC,
                ssbsect_subj_code,
                ssbsect_crse_numb,
                ssbsect_seq_numb;

   CURSOR insmcrsec (
      code_in       gtvinsm.gtvinsm_code%TYPE DEFAULT NULL
   )
   IS
      SELECT *
        FROM gtvinsm
       WHERE gtvinsm_code = code_in;

   insmcrsec_rec  insmcrsec%ROWTYPE;

   CURSOR sylncrsec (
      term_in       stvterm.stvterm_code%TYPE DEFAULT NULL,
      crn_in        ssbsect.ssbsect_crn%TYPE DEFAULT NULL
   )
   IS
      SELECT *
        FROM ssrsyln
       WHERE ssrsyln_term_code = term_in
         AND ssrsyln_crn = crn_in;

   sylncrsec_rec  sylncrsec%ROWTYPE;

   CURSOR aregcrsec (
      pidm_in       spriden.spriden_pidm%TYPE,
      term_in       stvterm.stvterm_code%TYPE DEFAULT NULL,
      crn_in        ssbsect.ssbsect_crn%TYPE DEFAULT NULL
   )
   IS
      SELECT *
        FROM sfrareg a
       WHERE sfrareg_term_code = term_in
         AND sfrareg_pidm = pidm_in
         AND sfrareg_crn = crn_in
         AND sfrareg_extension_number =
                    (SELECT MAX (sfrareg_extension_number)
                       FROM sfrareg x
                      WHERE x.sfrareg_pidm = a.sfrareg_pidm
                        AND x.sfrareg_crn = a.sfrareg_crn
                        AND x.sfrareg_term_code = a.sfrareg_term_code);

   aregcrsec_rec  aregcrsec%ROWTYPE;
--  end BWCKGEN globals

   crn          VARCHAR2(6) DEFAULT NULL;
   term_in      stvterm.stvterm_code%TYPE := ?;
   lv_pidm  spriden.spriden_pidm%TYPE     := ?;
   lv_tot_credit_hr VARCHAR2(12) default null;
   lv_course_title_caption VARCHAR2(120) default null;
   lv_dowebctlogin VARCHAR2(1);
   lv_sched_count NUMBER;

   lv_course_json VARCHAR2(32000);
   lv_errorMsg VARCHAR2(60) default null;

   CURSOR tot_credit_hr_c (
      pidm_in   spriden.spriden_pidm%TYPE,
      term_in   stvterm.stvterm_code%TYPE
   )
   IS
      SELECT SUM (DECODE (stvlevl_ceu_ind, 'Y', 0, NVL (sfrstcr_credit_hr, 0)))
        FROM stvlevl, sfrstcr
       WHERE stvlevl_code = sfrstcr_levl_code
         AND sfrstcr_pidm = pidm_in
         AND sfrstcr_term_code = term_in
         AND (
                   (   sfrstcr_error_flag <> 'F'
                    OR sfrstcr_error_flag IS NULL)
                OR (
                          sfrstcr_error_flag = 'F'
                      AND sfrstcr_rmsg_cde = 'MAXI'
                   )
             );

-- BWCKFRMT stuff
   CURSOR regsc (
      term_in   stvterm.stvterm_code%TYPE,
      crn_in    ssbsect.ssbsect_crn%TYPE,
      pidm_in   spriden.spriden_pidm%TYPE
   )
   IS
      SELECT sfrstcr_grde_date, ssbsect_credit_hrs, sfrstcr_credit_hr,
             scbcrse_credit_hr_ind, sobterm_cred_web_upd_ind,
             sobterm_gmod_web_upd_ind, sobterm_levl_web_upd_ind, stvgmod_desc,
             stvlevl_desc, ssbsect_subj_code, ssbsect_crse_numb,
             ssbsect_gmod_code
        FROM sfrstcr, ssbsect, scbcrse, sobterm, stvgmod, stvlevl
       WHERE sfrstcr_term_code = term_in
         AND sfrstcr_crn = crn_in
         AND sfrstcr_pidm = pidm_in
         AND ssbsect_crn = sfrstcr_crn
         AND ssbsect_term_code = sfrstcr_term_code
         AND sfrstcr_term_code = sobterm_term_code
         AND ssbsect_subj_code = scbcrse_subj_code
         AND ssbsect_crse_numb = scbcrse_crse_numb
         AND scbcrse_eff_term =
              (SELECT MAX (scbcrse_eff_term)
                 FROM scbcrse
                WHERE scbcrse_subj_code = ssbsect_subj_code
                  AND scbcrse_crse_numb = ssbsect_crse_numb
                  AND scbcrse_eff_term <= term_in)
         AND sfrstcr_gmod_code = stvgmod_code
         AND sfrstcr_levl_code = stvlevl_code;

   regs_rec                    regsc%ROWTYPE;


   CURSOR sirasgnc (p_term stvterm.stvterm_code%TYPE,
                       p_crn ssbsect.ssbsect_crn%TYPE,
                       p_cat sirasgn.sirasgn_category%TYPE DEFAULT NULL)
      IS
--         SELECT f_format_name (sirasgn_pidm, 'FMIL') instr_name,
--         SELECT 'X' instr_name, sirasgn_pidm,
           SELECT sirasgn_pidm,
                sirasgn_primary_ind, spriden_last_name, spriden_first_name, spriden_mi,
                spriden_surname_prefix
           FROM sirasgn, spriden
          WHERE sirasgn_pidm = spriden_pidm
            AND sirasgn_term_code = p_term
            AND sirasgn_crn = p_crn
            AND ( sirasgn_category = p_cat
                  OR p_cat IS NULL )
            AND spriden_change_ind IS NULL
      ORDER BY sirasgn_primary_ind, spriden_last_name, spriden_first_name, spriden_mi;

   FUNCTION p_instructor_links (
                  p_term IN stvterm.stvterm_code%TYPE,
                  p_crn IN ssbsect.ssbsect_crn%TYPE,
                  p_ptrm_code IN ssbsect.ssbsect_ptrm_code%TYPE DEFAULT NULL,
                  p_pidm IN spriden.spriden_pidm%TYPE DEFAULT NULL,
                  p_call_path IN VARCHAR2 DEFAULT 'S') RETURN VARCHAR2
      IS
         i NUMBER := 1;
         instr_pidms bwckfrmt.instr_pidms_tabtype;
         instr_names bwckfrmt.instr_names_tabtype;
         lv_json VARCHAR2(4000);

      BEGIN
        IF     (p_ptrm_code IS NULL)
            AND (p_pidm IS NOT NULL)
         THEN
         --OLR course with instructor found in SFRAREG
            instr_names(i) := f_format_name (p_pidm, 'FMIL');
            instr_pidms(i) := p_pidm;

            FOR sirasgn_row IN sirasgnc (p_term, p_crn)
            LOOP
               IF sirasgn_row.sirasgn_pidm = p_pidm
               THEN
                  NULL;
               ELSE
                  i:= i+1;
                  instr_names(i) := f_format_name (sirasgn_row.sirasgn_pidm, 'FMIL');
                  instr_pidms(i) := sirasgn_row.sirasgn_pidm;
               END IF;
            END LOOP;

         ELSE
         -- Traditional course, or OLR with no instructor found in SFRAREG
            FOR sirasgn_row IN sirasgnc (p_term, p_crn)
            LOOP
               instr_names(i) := f_format_name (sirasgn_row.sirasgn_pidm, 'FMIL');
               instr_pidms(i) := sirasgn_row.sirasgn_pidm;
               i:= i+1;
            END LOOP;

         END IF;

         lv_json := '{"rows": [';

         IF instr_pidms.COUNT > 0
         THEN
   --         twbkfrmt.p_tabledataopen;
            FOR j IN 1..instr_pidms.COUNT
            LOOP
               IF j = 1
               THEN
                  lv_json := lv_json || '{';
               ELSE
                  lv_json := lv_json || ',{';
               END IF;

               lv_json := lv_json || '"instructor": "' || instr_names(j) || '"}';
            END LOOP;

   --         twbkfrmt.p_tabledataclose;
   --      ELSE
   --         twbkfrmt.p_tabledata (ccolspan => '1');
         END IF;
         lv_json := lv_json || ']}';
         RETURN lv_json;

   END;
-- end BWCKFRMT stuff
--

BEGIN
--   IF NOT twbkwbis.f_validuser (global_pidm)
--   THEN
--      RETURN;
--   END IF;

   IF NOT bwskflib.f_validviewterm (term_in, stvterm_rec, sorrtrm_rec)
   THEN
      NULL;
   END IF;

--   IF NVL (twbkwbis.f_getparam (global_pidm, 'STUFAC_IND'), 'STU') = 'FAC'
--   THEN
--      genpidm :=
--          TO_NUMBER (twbkwbis.f_getparam (global_pidm, 'STUPIDM'), '999999999');
--      call_path := 'F';
--      not_registered_message :=
--        g$_nls.get ('BWCKGEN1-0009',
--           'SQL',
--           'No schedule available for selected term.');
--   ELSE
--      genpidm := global_pidm;
      genpidm := lv_pidm;
      call_path := 'S';
--      not_registered_message :=
--        g$_nls.get ('BWCKGEN1-0010',
--           'SQL',
--           'You are not currently registered for the term.');
--   END IF;

   term := term_in;
   row_count := 0;

--   IF call_path = 'S'
--   THEN
--      bwckfrmt.p_open_doc ('bwskfshd.P_CrseSchdDetl', term);
--   END IF;

--   twbkwbis.p_dispinfo ('bwskfshd.P_CrseSchdDetl', 'DEFAULT');
   cpinuse := twbkwbis.f_fetchwtparam ('cpinuse');

   IF cpinuse = 'Y'
   THEN
      makewebctlink := 'N';
   ELSE
      webctinuse := twbkwbis.f_fetchwtparam ('WEBCTINUSE');

      IF webctinuse = 'Y'
      THEN
         makewebctlink := 'Y';
         webctlogin := twbkwbis.f_fetchwtparam ('WEBCTLOGIN');

         IF webctlogin IS NULL
         THEN
            makewebctlink := 'N';
         END IF;
      ELSE
         makewebctlink := 'N';
      END IF;
   END IF;

   -- 8.4.0.2 HEOA
   -- Get the internal URL text outside the loop.
   lv_int_url_txt := bwckbook.f_get_internal_url_txt;
   lv_course_json := lv_course_json || '{"rows":[';
   FOR regcrse IN regcrsec (genpidm, term, crn, tmp_hist_ind)
   LOOP
      row_count := regcrsec%rowcount;


      sylncrsec_rec := NULL;
      OPEN sylncrsec (term, crn);
      FETCH sylncrsec INTO sylncrsec_rec;
      CLOSE sylncrsec;

      aregcrsec_rec := NULL;
      OPEN aregcrsec (genpidm, term, crn);
      FETCH aregcrsec INTO aregcrsec_rec;
      CLOSE aregcrsec;

      IF row_count = 1
      THEN
         /*  Calculate total credit hours for Schedule By Day and Time */
         OPEN tot_credit_hr_c (genpidm, term);
         FETCH tot_credit_hr_c INTO tot_credit_hr;
         CLOSE tot_credit_hr_c;
-- Prints header:
--------

--         twbkfrmt.p_printtext (
--            g$_nls.get ('BWCKGEN1-0011', 'SQL', 'Total Credit Hours') || ': ' ||
--               LTRIM (TO_CHAR (tot_credit_hr, '99990D990'))
--         );
--         HTP.br;
--         HTP.br;
         lv_tot_credit_hr :=  LTRIM (TO_CHAR (tot_credit_hr, '99990D990'));
         lv_course_json := lv_course_json || '{"tot_credits":"' || lv_tot_credit_hr || '",';
      ELSE
         lv_course_json := lv_course_json || ', {';
      END IF;

      FOR scbcrse IN scklibs.scbcrsec (
                        regcrse.ssbsect_subj_code,
                        regcrse.ssbsect_crse_numb,
                        term
                     )
      LOOP
         scbcrse_row := scbcrse;
      END LOOP;

      IF makewebctlink = 'N' OR
         regcrse.ssbsect_intg_cde IS NULL
      THEN
--         twbkfrmt.p_tableopen (
--            'DATADISPLAY',
--            cattributes   => 'SUMMARY="' ||
--                                g$_nls.get ('BWCKGEN1-0012',
--                                   'SQL',
--                                   'This layout table is used to present the schedule course detail') ||
--                                '"',
--            ccaption      => bwcklibs.f_course_title (
--                                term_in,
--                                regcrse.ssbsect_crn
--                             ) ||
--                                ' - ' ||
--                                regcrse.ssbsect_subj_code ||
--                                ' ' ||
--                                regcrse.ssbsect_crse_numb ||
--                                ' - ' ||
--                               regcrse.ssbsect_seq_numb
--         );
         lv_dowebctlogin := 'Y';
      ELSE
--         twbkfrmt.p_tableopen (
--            'DATADISPLAY',
--            cattributes   => 'SUMMARY="' ||
--                                g$_nls.get ('BWCKGEN1-0013',
--                                   'SQL',
--                                   'This layout table is used to present the schedule course detail') ||
--                                '"'
--         );
--         webctlink :=
--           bwcklibs.f_course_title (term_in, regcrse.ssbsect_crn) || ' - ' ||
--              regcrse.ssbsect_subj_code ||
--              ' ' ||
--              regcrse.ssbsect_crse_numb ||
--              ' - ' ||
--              regcrse.ssbsect_seq_numb;
--         webctlink :=
--           twbkfrmt.f_printanchor (
--              webctlogin,
--              webctlink,
--              '',
--              '',
--              bwckfrmt.f_anchor_focus (webctlogin)
--           );
--         twbkfrmt.p_tableheader (
--            twbkfrmt.f_printtext (webctlink, BYPASS_ESC=>'Y'),
--            ccolspan   => 3, cattributes=>'BYPASS_ESC=Y'
--         );
         lv_dowebctlogin := 'N';
      END IF;
      lv_course_title_caption := bwcklibs.f_course_title (
                       term_in,
                       regcrse.ssbsect_crn
                    ) ||
                       ' - ' ||
                       regcrse.ssbsect_subj_code ||
                       ' ' ||
                       regcrse.ssbsect_crse_numb ||
                       ' - ' ||
                       regcrse.ssbsect_seq_numb;
      lv_course_json := lv_course_json || '"doWebCtLink": "' || lv_dowebctlogin|| '",';
      lv_course_json := lv_course_json || '"webctlogin": "' || webctlogin || '",';
      lv_course_json := lv_course_json || '"course_title": "' || lv_course_title_caption || '",';

--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         g$_nls.get ('BWCKGEN1-0014', 'SQL', 'Associated Term:'),
--         ccolspan   => 2
--      );
--      twbkfrmt.p_tabledata (bwcklibs.f_term_desc (term_in));
      lv_course_json := lv_course_json || '"assoc_term": "' || bwcklibs.f_term_desc (term_in) || '",';
--      twbkfrmt.p_tablerowclose;
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         twbkfrmt.f_printtext (
--            '<ACRONYM title = "' ||
--               g$_nls.get ('BWCKGEN1-0015', 'SQL', 'Course Reference Number') ||
--               '">' ||
--               g$_nls.get ('BWCKGEN1-0016', 'SQL', 'CRN') ||
--               '</ACRONYM>'
--         ) ||
--            ':',
--         ccolspan   => 2
--      );
--      twbkfrmt.p_tabledata (regcrse.ssbsect_crn);
      lv_course_json := lv_course_json || '"crn": "' || regcrse.ssbsect_crn || '",';
--      twbkfrmt.p_tablerowclose;
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         g$_nls.get ('BWCKGEN1-0017', 'SQL', 'Status:'),
--         ccolspan   => 2
--      );
--      twbkfrmt.p_tabledata (
--         g$_nls.get ('BWCKGEN1-0018',
--            'SQL',
--            '%01% on %02%',
--            regcrse.stvrsts_desc,
--            TO_CHAR (regcrse.sfrstcr_rsts_date, twbklibs.date_display_fmt)
--         )
--      );
      lv_course_json := lv_course_json || '"status_01": "' || regcrse.stvrsts_desc || '",';
      lv_course_json := lv_course_json || '"status_02": "' || TO_CHAR (regcrse.sfrstcr_rsts_date, twbklibs.date_display_fmt) || '",';
--      twbkfrmt.p_tablerowclose;

      -- WaitList automation enhancement begins.
      IF sfkwlat.f_display_position(term, regcrse.ssbsect_crn) = 'Y' AND
         sfkwlat.f_wl_automation_active( term, regcrse.ssbsect_crn ) = 'Y' AND
         regcrse.stvrsts_voice_type = 'L'
      THEN
--        twbkfrmt.p_tablerowopen;
--        twbkfrmt.p_tabledatalabel(
--            g$_nls.get('BWCKGEN1-0019', 'SQL', 'Waitlist Position:'),
--            ccolspan   => 2
--        );
--        twbkfrmt.p_tabledata(
--            sfkwlat.f_get_wl_pos( p_pidm  =>  genpidm,
--                                  p_term  =>  term_in,
--                                  p_crn   =>  regcrse.ssbsect_crn
--                                )
--        );
        lv_course_json := lv_course_json || '"waitlist_pos": "' || sfkwlat.f_get_wl_pos( p_pidm  =>  genpidm,
                                  p_term  =>  term_in,
                                  p_crn   =>  regcrse.ssbsect_crn
                                ) || '",';
--        twbkfrmt.p_tablerowclose;
        lv_wl_notification_ref := sb_wl_notification.f_query_one( p_term_code  =>  term_in,
                                                                  p_crn        =>  regcrse.ssbsect_crn ,
                                                                  p_pidm       =>  genpidm );
        FETCH lv_wl_notification_ref INTO lv_wl_notification_rec;
        IF lv_wl_notification_ref%NOTFOUND THEN
          lv_wl_notification_rec.r_end_date:=NULL;
        END IF;
        CLOSE lv_wl_notification_ref;

--        twbkfrmt.p_tablerowopen;
--        twbkfrmt.p_tabledatalabel(
--            g$_nls.get('BWCKGEN1-0020', 'SQL', 'Notification Expires:'),
--            ccolspan   => 2
--        );
--        twbkfrmt.p_tabledata(
--            TO_CHAR ( lv_wl_notification_rec.r_end_date,
--                      twbklibs.twgbwrul_rec.twgbwrul_date_fmt
--                    ) ||
--            ' ' ||
--            TO_CHAR ( lv_wl_notification_rec.r_end_date,
--                      twbklibs.twgbwrul_rec.twgbwrul_time_fmt
--                    )
--        );
        lv_course_json := lv_course_json || '"notif_expire": "' || TO_CHAR ( lv_wl_notification_rec.r_end_date,
                      twbklibs.twgbwrul_rec.twgbwrul_time_fmt
                    ) || '",';

--        twbkfrmt.p_tablerowclose;
      END IF ;
      -- Waitlist automation enhancement ends.

      IF sfkolrl.f_open_learning_course (term_in, regcrse.ssbsect_crn)
      THEN
--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledatalabel (
--            g$_nls.get ('BWCKGEN1-0021', 'SQL', 'Class Start Date:'),
--            ccolspan   => 2
--         );
--         twbkfrmt.p_tabledata (
--            TO_CHAR (aregcrsec_rec.sfrareg_start_date, twbklibs.date_display_fmt)
--         );
         lv_course_json := lv_course_json || '"class_start": "' || TO_CHAR (aregcrsec_rec.sfrareg_start_date, twbklibs.date_display_fmt) || '",';
--         twbkfrmt.p_tablerowclose;
--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledatalabel (
--            g$_nls.get ('BWCKGEN1-0022', 'SQL', 'Expected Completion Date:'),
--            ccolspan   => 2
--         );
--         twbkfrmt.p_tabledata (
--            TO_CHAR (
--               aregcrsec_rec.sfrareg_completion_date,
--               twbklibs.date_display_fmt
--            )
--         );
         lv_course_json := lv_course_json || '"expected_comp": "' || TO_CHAR (
               aregcrsec_rec.sfrareg_completion_date,
               twbklibs.date_display_fmt
            ) || '",';
--         twbkfrmt.p_tablerowclose;
      END IF;

--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         g$_nls.get ('BWCKGEN1-0023', 'SQL', 'Assigned Instructor:'),
--         ccolspan   => 2
--      );

--      bwckfrmt.p_instructor_links ( -- just get the names, and email addresses
--               regcrse.sfrstcr_term_code, regcrse.sfrstcr_crn,
--               regcrse.ssbsect_ptrm_code, aregcrsec_rec.sfrareg_instructor_pidm,
--               call_path);
      lv_course_json := lv_course_json || '"instructors": ' || p_instructor_links ( -- just get the names, and email addresses
               regcrse.sfrstcr_term_code, regcrse.sfrstcr_crn,
               regcrse.ssbsect_ptrm_code, aregcrsec_rec.sfrareg_instructor_pidm,
               call_path) || ',';

--      twbkfrmt.p_tablerowclose;
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         g$_nls.get ('BWCKGEN1-0024', 'SQL', 'Grade Mode:'),
--         ccolspan   => 2
--      );
--      bwckfrmt.p_disp_grade_mode (term_in, regcrse.ssbsect_crn);
      OPEN regsc (term_in, regcrse.ssbsect_crn, genpidm);
      FETCH regsc INTO regs_rec;
      CLOSE regsc;
      lv_course_json := lv_course_json || '"grade_mode": "' || regs_rec.stvgmod_desc || '",';
--     twbkfrmt.p_tablerowclose;
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         g$_nls.get ('BWCKGEN1-0025', 'SQL', 'Credits:'),
--         ccolspan   => 2
--      );
--      bwckfrmt.p_disp_credit_hours (term_in, regcrse.ssbsect_crn);
      lv_course_json := lv_course_json || '"credits": "' || TO_CHAR (regs_rec.sfrstcr_credit_hr, '9990D990') || '",';
--      twbkfrmt.p_tablerowclose;
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         g$_nls.get ('BWCKGEN1-0026', 'SQL', 'Level:'),
--         ccolspan   => 2
--      );
--      bwckfrmt.p_disp_level (term_in, regcrse.ssbsect_crn);
      lv_course_json := lv_course_json || '"level": "' || regs_rec.stvlevl_desc || '",';
--      twbkfrmt.p_tablerowclose;
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledatalabel (
--         g$_nls.get ('BWCKGEN1-0027', 'SQL', 'Campus:'),
--         ccolspan   => 2
--      );
--      twbkfrmt.p_tabledata (regcrse.stvcamp_desc);
      lv_course_json := lv_course_json || '"campus": "' || regcrse.stvcamp_desc || '",';
--      twbkfrmt.p_tablerowclose;

      --
      -- HEOA support start
      --

      --
      -- HEOA support stop
      --
--      IF sylncrsec_rec.ssrsyln_section_url IS NOT NULL
--      THEN
--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledatalabel (
--            twbkfrmt.f_printtext (
--               g$_nls.get ('BWCKGEN1-0028', 'SQL', 'Course ') ||
--                  '<ACRONYM title = "' ||
--                  g$_nls.get ('BWCKGEN1-0029',
--                     'SQL',
--                     'Uniform Resource Locator') ||
--                  '">' ||
--                  g$_nls.get ('BWCKGEN1-0030', 'SQL', 'URL') ||
--                  '</ACRONYM>' ||
--                  ':'
--            ),
--            ccolspan   => 2
--         );
--         twbkfrmt.p_tabledata (
--            twbkfrmt.f_printanchor (
--               twbkfrmt.f_encodeurl (sylncrsec_rec.ssrsyln_section_url),
--               sylncrsec_rec.ssrsyln_section_url
--            )
--         );
--         twbkfrmt.p_tablerowclose;
--      END IF;

--      twbkfrmt.p_tableclose;
--      bwckfrmt.p_disp_meeting_times (term_in, regcrse.ssbsect_crn);
      pdm_crn_in := regcrse.ssbsect_crn;
      pdm_term_in := term_in;
--    p_disp_meeting_times as inline BEGIN
      lv_course_json := lv_course_json || '"tbl_meetings": [';
      FOR ssrmeet IN bwcklibs.ssrmeetc (pdm_crn_in, pdm_term_in)
      LOOP
         IF NOT meeting_times_found
         THEN
            lv_course_json := lv_course_json || '{';
         ELSE
            lv_course_json := lv_course_json || ', {';
         END IF;
         meeting_times_found := TRUE;

--         IF bwcklibs.ssrmeetc%rowcount = 1
--         THEN
--            p_open_table;
--         END IF;

--         twbkfrmt.p_tablerowopen;
         /* type */
--         twbkfrmt.p_tabledata (ssrmeet.gtvmtyp_desc);
         lv_course_json := lv_course_json || '"type": "' || ssrmeet.gtvmtyp_desc || '",';
         /* time */
         pdm_hold_beg_time :=
           TO_CHAR (
              TO_DATE (ssrmeet.ssrmeet_begin_time, 'HH24MI'),
              twbklibs.twgbwrul_rec.twgbwrul_time_fmt
           );                                                 --  'am' or 'pm'

         IF SUBSTR (pdm_hold_beg_time, 1, 1) = '0'
         THEN
            pdm_hold_beg_time := SUBSTR (pdm_hold_beg_time, 2, 29);
         ELSE
            pdm_hold_beg_time := SUBSTR (pdm_hold_beg_time, 1, 30);
         END IF;

         pdm_hold_end_time :=
           TO_CHAR (
              TO_DATE (ssrmeet.ssrmeet_end_time, 'HH24MI'),
              twbklibs.twgbwrul_rec.twgbwrul_time_fmt
           );

         IF SUBSTR (pdm_hold_end_time, 1, 1) = '0'
         THEN
            pdm_hold_end_time := SUBSTR (pdm_hold_end_time, 2, 29);
         ELSE
            pdm_hold_end_time := SUBSTR (pdm_hold_end_time, 1, 30);
         END IF;

--         IF ssrmeet.ssrmeet_begin_time IS NULL
--         THEN
--            twbkfrmt.p_tabledata (
--               twbkfrmt.f_printtext (
--                  '<ABBR title = "' ||
--                     g$_nls.get ('BWCKFRM1-0021', 'SQL', 'To Be Announced') ||
--                     '">' ||
--                     g$_nls.get ('BWCKFRM1-0022', 'SQL', 'TBA') ||
--                     '</ABBR>'
--               )
--            );
--         ELSE
--            twbkfrmt.p_tabledata (pdm_hold_beg_time || ' - ' || pdm_hold_end_time);
--         END IF;
         lv_course_json := lv_course_json || '"times":"' || pdm_hold_beg_time || ' - ' || pdm_hold_end_time || '",';

         /* days */
--         twbkfrmt.p_tabledata (
--            LTRIM (
--               RTRIM (g$_date.nls_abv_day(ssrmeet.ssrmeet_mon_day) ||
--                      g$_date.nls_abv_day(ssrmeet.ssrmeet_tue_day) ||
--                      g$_date.nls_abv_day(ssrmeet.ssrmeet_wed_day) ||
--                      g$_date.nls_abv_day(ssrmeet.ssrmeet_thu_day) ||
--                      g$_date.nls_abv_day(ssrmeet.ssrmeet_fri_day) ||
--                      g$_date.nls_abv_day(ssrmeet.ssrmeet_sat_day) ||
--                      g$_date.nls_abv_day(ssrmeet.ssrmeet_sun_day)
--               )
--            )
--         );
         lv_course_json := lv_course_json || '"days": "' || ssrmeet.ssrmeet_mon_day ||
                      ssrmeet.ssrmeet_tue_day ||
                      ssrmeet.ssrmeet_wed_day ||
                      ssrmeet.ssrmeet_thu_day ||
                      ssrmeet.ssrmeet_fri_day ||
                      ssrmeet.ssrmeet_sat_day ||
                      ssrmeet.ssrmeet_sun_day || '", ';

         /* where */
         lv_course_json := lv_course_json || '"where": [';
--         IF ssrmeet.ssrmeet_bldg_code IS NULL
         IF ssrmeet.ssrmeet_bldg_code IS NOT NULL
         THEN
--            twbkfrmt.p_tabledata (
--               twbkfrmt.f_printtext (
--                  '<ABBR title = "' ||
--                     g$_nls.get ('BWCKFRM1-0023', 'SQL', 'To Be Announced') ||
--                     '">' ||
--                     g$_nls.get ('BWCKFRM1-0024', 'SQL', 'TBA') ||
--                     '</ABBR>'
--               )
--            );
--       ELSE
            lv_sched_count := 0;
            FOR stvbldg IN stkbldg.stvbldgc (ssrmeet.ssrmeet_bldg_code)
            LOOP
               lv_sched_count := lv_sched_count + 1;
--               twbkfrmt.p_tabledata (
--                  stvbldg.stvbldg_desc || ' ' || ssrmeet.ssrmeet_room_code
--               );
               IF lv_sched_count > 1
               THEN
                  lv_course_json := lv_course_json || ',';
               END IF;
               lv_course_json := lv_course_json || '"' || stvbldg.stvbldg_desc || ' ' || ssrmeet.ssrmeet_room_code || '"';
            END LOOP;
         END IF;
         lv_course_json := lv_course_json || '],';

         /* date range */
--         twbkfrmt.p_tabledata (
--            TO_CHAR (ssrmeet.ssrmeet_start_date, twbklibs.date_display_fmt) ||
--               ' - ' ||
--               TO_CHAR (ssrmeet.ssrmeet_end_date, twbklibs.date_display_fmt)
--         );
         lv_course_json := lv_course_json || '"meet_start": "' || TO_CHAR (ssrmeet.ssrmeet_start_date, 'MM/DD/YYYY') || '",';
         lv_course_json := lv_course_json || '"meet_end": "' || TO_CHAR (ssrmeet.ssrmeet_end_date, 'MM/DD/YYYY') || '",';

         /* schedule type */
         lv_course_json := lv_course_json || '"sched_type": [';
         lv_sched_count := 0;
         FOR stvschd IN stkschd.stvschdc (ssrmeet.ssrmeet_schd_code)
         LOOP
            lv_sched_count := lv_sched_count + 1;
--            twbkfrmt.p_tabledata (stvschd.stvschd_desc);
            IF lv_sched_count > 1
            THEN
               lv_course_json := lv_course_json || ',';
            END IF;
            lv_course_json := lv_course_json || '"' || stvschd.stvschd_desc || '"';
         END LOOP;
         lv_course_json := lv_course_json || ']';


         /* instructors */
--         p_instructor_list(
--            pdm_term_in, pdm_crn_in, ssrmeet.ssrmeet_catagory, p_display_email => TRUE
--            );
--       should already have this info
--         twbkfrmt.p_tablerowclose;
         lv_course_json := lv_course_json || '}';
      END LOOP;
      lv_course_json := lv_course_json || ']';

      IF NOT meeting_times_found
      THEN
         IF sfkolrl.f_open_learning_course (pdm_term_in, pdm_crn_in)
         THEN
            instr_name := NULL;
            hold_instr_name := NULL;

            FOR sirasgnc_row IN sirasgnc (pdm_term_in, pdm_crn_in)
            LOOP
               IF NVL (sirasgnc_row.sirasgn_primary_ind, 'N') = 'Y'
               THEN
--                  primary_ind :=
--                    '(' || '<ABBR title= "' ||
--                       g$_nls.get ('BWCKFRM1-0025', 'SQL', 'Primary') ||
--                       '">' ||
--                       g$_nls.get ('BWCKFRM1-0026', 'SQL', 'P') ||
--                       '</ABBR>' ||
--                       ')';
                  primary_ind := 'P';
               ELSE
                  primary_ind := '';
               END IF;

               IF twbkfrmt.f_display_ssb_field ('/BWCKFRMT.p_disp_meeting_times', 'spriden_surname_prefix') = 'Y' --Masking Code for I18N
               THEN
                  hold_instr_name :=
                     (sirasgnc_row.spriden_first_name||' '||sirasgnc_row.spriden_mi||' '||sirasgnc_row.spriden_surname_prefix||' '||sirasgnc_row.spriden_last_name);
               ELSE
                  hold_instr_name :=
                     (sirasgnc_row.spriden_first_name||' '||sirasgnc_row.spriden_mi||' '||sirasgnc_row.spriden_last_name);
               END IF;
--               temp_instr_name := hold_instr_name || ' ' || primary_ind ||
--                  bwckfrmt.f_disp_instr_email_icon (sirasgnc_row.sirasgn_pidm);
               temp_instr_name := '"'||  hold_instr_name || ' ' || primary_ind || '"';

               IF instr_name IS NULL
               THEN
                  instr_name := temp_instr_name;
               ELSIF length(instr_name || ', ' || temp_instr_name) < 3001
               THEN
                  instr_name := instr_name || ', ' || temp_instr_name;
               END IF;

            END LOOP;

            IF instr_name IS NOT NULL
            THEN
--               p_open_table;
--               twbkfrmt.p_tablerowopen;
--               twbkfrmt.p_tabledatadead (ccolspan => 6);
--               twbkfrmt.p_tabledata (instr_name, cattributes=>'BYPASS_ESC=Y');
               lv_course_json := lv_course_json || '"instr_names": [' || instr_name || ']';
--               twbkfrmt.p_tablerowclose;
            END IF;
         END IF;
      END IF;

      meeting_times_found := false;

--      IF table_opened
--      THEN
--         twbkfrmt.p_tableclose;
--      END IF;

      instr_name := NULL;
--      HTP.br;
--   END p_disp_meeting_times;
--    p_disp_meeting_times as inline END

      lv_course_json := lv_course_json || '}';
   END LOOP;
   lv_course_json := lv_course_json || '],';
   IF row_count = 0
   THEN
--      twbkfrmt.p_printmessage (not_registered_message);
      lv_errorMsg := 'notRegistered';
   END IF;
   lv_course_json := lv_course_json || '"errorMsg": "'|| lv_errorMsg ||'"}';

   ? := lv_course_json;
--   dbms_output.put_line(lv_course_json);
--   bwckfrmt.p_disp_back_anchor;
--END P_DispCrseSchdDetl;
END;
    """
}


getNeedCalculation {
    sqlText = """
--PROCEDURE P_ShowNeedCalc(pidm  NUMBER,
--                         aidy  robinst.robinst_aidy_code%TYPE,
--                         WIDTH VARCHAR2) IS
declare
   pidm  NUMBER := ?;
   aidy  robinst.robinst_aidy_code%TYPE := ?;

   budget_amount   NUMBER := 0;
   efc             NUMBER := 0;
   init_need       NUMBER := 0;
   resource_amount NUMBER := 0;
   need            NUMBER := 0;

   lv_json VARCHAR2(32000);

   TYPE resources_rec IS RECORD(
      resource_desc rprarsc.rprarsc_resource_desc%TYPE,
      term_code     rprarsc.rprarsc_term_code%TYPE,
      est_amt       rprarsc.rprarsc_est_amt%TYPE,
      actual_amt    rprarsc.rprarsc_actual_amt%TYPE);

   resources_r resources_rec; -- 081000-1
   arsc_c      rokrefc.arsc_cur; -- 081000-1
   arsc_r      rokrefc.arsc_rec; -- 081000-1

   need_rec rnkneed.needrectype; -- 081401-2
   efc_ind  VARCHAR2(1); -- 081401-2

   CURSOR need_calc_c IS
   SELECT budget_amount,
         efc,
         budget_amount - efc init_need,
         need
   FROM  (SELECT NVL(rnvand0_budget_amount, 0) budget_amount,
                  --          FROM (SELECT NVL(bwrkbudg.f_get_budget_total(aidy, pidm), 0) BUDGET_AMOUNT,               -- 081200-1
                  NVL(CASE
                        WHEN rnvand0_efc_ind = 'I' THEN
                         rnvand0_im_efc_amt
                        ELSE
                         rnvand0_efc_amt
                      END,
                      0) efc,
                  NVL(CASE
                        WHEN rnvand0_efc_ind = 'I' THEN
                         rnvand0_im_gross_need
                        ELSE
                         rnvand0_gross_need
                      END,
                      0) need
           FROM   rnvand0
           WHERE  rnvand0_aidy_code = aidy
           AND    rnvand0_pidm = pidm) x;

   -- 081000-1
   CURSOR resources_c(pidm NUMBER,
                     aidy robinst.robinst_aidy_code%TYPE) IS
      SELECT rprarsc_resource_desc,
             rprarsc_term_code,
             rprarsc_est_amt, -- 081200-5
             rprarsc_actual_amt -- 081200-5
      FROM   rprarsc
      WHERE  rprarsc_pidm = pidm
      AND    rprarsc_info_access_ind = 'Y'
      AND    ((rprarsc_arsc_code IS NOT NULL AND
            rprarsc_info_access_ind =
            (SELECT rtvarsc_info_access_ind
                FROM   rtvarsc
                WHERE  rtvarsc_code = rprarsc_arsc_code
                AND    rtvarsc_info_access_ind = 'Y')) OR rprarsc_arsc_code IS NULL)
      AND    ((rprarsc_aidy_code = aidy AND rprarsc_term_code IS NULL) OR
            (rprarsc_term_code IS NOT NULL AND
            rprarsc_term_code IN
            (SELECT rorprds_term_code
                FROM   rorprds,
                       rortprd,
                       rorstat
                WHERE  rorstat_pidm = pidm
                AND    rorstat_aidy_code = aidy
                AND    rorprds_period = rortprd_period
                AND    rortprd_aidy_code = aidy
                AND    rortprd_aprd_code = rorstat_aprd_code)));

BEGIN
   -- 081401-2
   IF (rbk_period_budget.f_period_budget_enabled(aidy) = 'N')
   THEN
      OPEN need_calc_c;
      FETCH need_calc_c
      INTO budget_amount,
           efc,
           init_need,
           need;
      CLOSE need_calc_c;

      -- Other resources                                                         -- 081000-1
      OPEN resources_c(pidm, aidy);
      FETCH resources_c
      INTO resources_r;
      WHILE resources_c%FOUND LOOP
         resource_amount := resource_amount +
                           NVL(NVL(resources_r.actual_amt, resources_r.est_amt), 0); -- 081200-5
         FETCH resources_c
         INTO resources_r;
      END LOOP;
      CLOSE resources_c;

      -- Contracts and Exemptions                                                -- 081000-1
      rokrefc.p_get_arsc_data(p_resultset_inout => arsc_c,
                              p_aidy_code       => aidy,
                              p_pidm            => pidm);
      FETCH arsc_c
       INTO arsc_r;
      WHILE arsc_c%FOUND LOOP
        IF arsc_r.arsc_rec_info_access_ind = 'Y' THEN
          resource_amount := resource_amount + NVL(NVL(arsc_r.arsc_rec_actual_amt,
                                                       arsc_r.arsc_rec_estimated_amt),
                                                   0); -- 081200-5
        END IF;
        FETCH arsc_c
         INTO arsc_r;
      END LOOP;
      CLOSE arsc_c;

   ELSE
      efc_ind := bwrkbudg.f_get_budget_efc_ind(aidy, pidm);

      IF efc_ind IS NULL THEN
         RETURN;
      END IF;

      need_rec := rnkneed.f_get_need_data(pidm, aidy);

      resource_amount := need_rec.resource_amount;

      IF efc_ind = 'F' THEN
         budget_amount := need_rec.fm_budget_amount;
         efc           := need_rec.fm_efc_amt;
         init_need     := need_rec.fm_gross_need;
         need          := need_rec.fm_unmet_need;
      ELSIF efc_ind = 'I' THEN
         budget_amount := need_rec.im_budget_amount;
         efc           := need_rec.im_efc_amt;
         init_need     := need_rec.im_gross_need;
         need          := need_rec.im_unmet_need;
      END IF;
   END IF;

   --twbkfrmt.p_tableopen('DATADISPLAY',
   --                   cattributes  => rb_misc_parameter.f_get_data(p_parameter => 'HTML_TABLE_PARMS',
   --                                                                p_key       => 'bwrkrhst.P_ShowNeedCalc') || -- 081801-4
   --                                   'width="' || WIDTH || '" SUMMARY= "' ||
   --                                   g$_nls.get('BWRKRHS1-0016',
   --                                              'SQL',
   --                                              'This table lists the need calculation.') || '"',
   --                   ccaption     => g$_nls.get('BWRKRHS1-0017',
   --                                              'SQL',
   --                                              'Need Calculation'));
 /* 081401-1 Removed
      twbkfrmt.P_TableRowOpen;
      twbkfrmt.P_TableDataHeader(g$_nls.get('BWRKRHS1-0019', 'SQL', 'Component'));
      twbkfrmt.P_TableDataHeader(g$_nls.get('BWRKRHS1-0020', 'SQL', 'Amount'), 'right');
      twbkfrmt.P_TableRowClose;
 */
   lv_json := '{';
   --P_ShowCalcDetail(g$_nls.get('BWRKRHS1-0018', 'SQL', 'Cost of Attendance'), budget_amount);
   lv_json := lv_json || '"attendanceCost": ' || nvl(budget_amount,0) || ',';
   --P_ShowCalcDetail(g$_nls.get('BWRKRHS1-0019', 'SQL', 'Estimated Family Contribution'), efc);
   lv_json := lv_json || '"familyContrib": ' || nvl(efc,0) || ',';
   --P_ShowCalcDetail(g$_nls.get('BWRKRHS1-0020', 'SQL', 'Initial Need'), init_need);
   lv_json := lv_json || '"initialNeed": ' || nvl(init_need,0) || ',';
   --P_ShowCalcDetail(g$_nls.get('BWRKRHS1-0021', 'SQL', 'Outside Resource'), resource_amount);
   lv_json := lv_json || '"outsideResrc": ' || nvl(resource_amount,0) || ',';
   --P_ShowCalcDetail(g$_nls.get('BWRKRHS1-0022', 'SQL', 'Need'), need);
   lv_json := lv_json || '"need": ' || nvl(need,0);
   lv_json := lv_json || '}';
-- twbkfrmt.p_tableclose;
-- htp.br;
   ? := lv_json;
end;
--END P_ShowNeedCalc;
"""
}



getHousingStatus {
    sqlText = """
--PROCEDURE P_ShowHousing(pidm  NUMBER,
--                       aidy  robinst.robinst_aidy_code%TYPE,
--                       WIDTH VARCHAR2) IS
declare
   pidm  NUMBER := ?;
   aidy  robinst.robinst_aidy_code%TYPE := ?;

   housing rormval.rormval_desc%TYPE;

   CURSOR housing_c IS
   SELECT rormval_desc
   FROM   rcrapp1,
          rormval
   WHERE  rcrapp1_aidy_code = aidy
   AND    rcrapp1_pidm = pidm
   AND    rcrapp1_curr_rec_ind = 'Y'
   AND    rcrapp1_aidy_code = rormval_key_1
   AND    rcrapp1_inst_hous_cde = rormval_code
   AND    rormval_column = 'RCRAPP1_INST_HOUS_CDE';

   lv_count      NUMBER;
   lv_house_json VARCHAR2(1000) := '{}';

   BEGIN
      OPEN housing_c;
      FETCH housing_c
      INTO housing;

      IF housing_c%FOUND
      THEN
--         twbkfrmt.p_tableopen('DATADISPLAY',
--                              cattributes  => rb_misc_parameter.f_get_data(p_parameter => 'HTML_TABLE_PARMS',
--                                                                           p_key       => 'bwrkrhst.P_ShowHousing') || -- 081801-4
--                                              'width="' || WIDTH || '" SUMMARY= "' ||
--                                              g$_nls.get('BWRKRHS1-0025',
--                                                         'SQL',
--                                                         'This table lists the housing.') || '"',
--                              ccaption     => g$_nls.get('BWRKRHS1-0026', 'SQL', 'Housing'));

--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0027', 'SQL', 'Status'));
--         twbkfrmt.p_tablerowclose;


         lv_house_json := '{"rows": [';
         lv_count := 0;
         WHILE housing_c%FOUND LOOP
--            twbkfrmt.p_tablerowopen;
--            twbkfrmt.p_tabledata(housing);
            lv_count := lv_count + 1;
            if lv_count > 1
            then
               lv_house_json := lv_house_json || ',';
            end if;
            lv_house_json := lv_house_json || '"' || housing || '"';
--            twbkfrmt.p_tablerowclose;
            FETCH housing_c
             INTO housing;
         END LOOP;
         lv_house_json := lv_house_json || ']}';

--         twbkfrmt.p_tableclose;
--         htp.br;
      END IF;
      CLOSE housing_c;
   ? := lv_house_json;
end;
--END P_ShowHousing;
"""
}



getEnrollment {
    sqlText = """
--PROCEDURE P_ShowEnrollment(pidm   NUMBER,
--                          aidy   robinst.robinst_aidy_code%TYPE,
--                          WIDTH  VARCHAR2,
--                          status rorwebr.rorwebr_enrollment_status%TYPE) IS
declare
   pidm   NUMBER := ?;
   aidy   robinst.robinst_aidy_code%TYPE := ?;
   status rorwebr.rorwebr_enrollment_status%TYPE := ?;

   summer_t        rcrapp1.rcrapp1_rqst_fa_summer_this_yr%TYPE := NULL;
   fall            rcrapp1.rcrapp1_rqst_fa_fall_this_yr%TYPE := NULL;
   winter          rcrapp1.rcrapp1_rqst_fa_winter_next_yr%TYPE := NULL;
   spring          rcrapp1.rcrapp1_rqst_fa_spring_next_yr%TYPE := NULL;
   summer_n        rcrapp1.rcrapp1_rqst_fa_summer_next_yr%TYPE := NULL;
   est_enroll_pell rpbopts.rpbopts_est_enroll_pell_ind%TYPE := NULL;
   exp_enroll_stat rcrapp1.rcrapp1_exp_enroll_status%TYPE := NULL;
   default_option  rpbopts.rpbopts_default_option_ind%TYPE := NULL;

   lv_enroll_json VARCHAR2(32000);

   CURSOR period_c IS
     SELECT rcrapp1_rqst_fa_summer_this_yr,
            rcrapp1_rqst_fa_fall_this_yr,
            rcrapp1_rqst_fa_winter_next_yr,
            rcrapp1_rqst_fa_spring_next_yr,
            rcrapp1_rqst_fa_summer_next_yr,
            rcrapp1_exp_enroll_status
     FROM   rcrapp1
     WHERE  rcrapp1_aidy_code = aidy
     AND    rcrapp1_pidm = pidm
     AND    rcrapp1_curr_rec_ind = 'Y';

   CURSOR est_enroll_pell_c IS
     SELECT rpbopts_est_enroll_pell_ind,
            rpbopts_default_option_ind
     FROM   rpbopts
     WHERE  rpbopts_aidy_code = aidy;

   FUNCTION f_showenrollmentdesc(aidy   robinst.robinst_aidy_code%TYPE,
                                 period VARCHAR2,
                                 COLUMN VARCHAR2,
                                 CODE   VARCHAR2) RETURN VARCHAR2 IS

      period_desc rormval.rormval_desc%TYPE;

      CURSOR enrollment_desc_c IS
        SELECT rormval_desc
        FROM   rormval
        WHERE  rormval_key_1 = aidy
        AND    rormval_code = CODE
        AND    rormval_column = COLUMN;

      lv_enrollment_desc VARCHAR2(120);
   BEGIN
      OPEN enrollment_desc_c;
      FETCH enrollment_desc_c
        INTO period_desc;
      IF enrollment_desc_c%FOUND THEN
--         twbkfrmt.p_tablerowopen;
         IF period IS NOT NULL THEN
--           twbkfrmt.p_tabledata(period || ': ');
            lv_enrollment_desc := period || ':';
         END IF;
--         twbkfrmt.p_tabledata(period_desc);
         lv_enrollment_desc := lv_enrollment_desc || period_desc;
--         twbkfrmt.p_tablerowclose;
      END IF;
      CLOSE enrollment_desc_c;
      return lv_enrollment_desc;
   END f_showenrollmentdesc;
BEGIN
--   twbkfrmt.p_tableopen('DATADISPLAY',
--                        cattributes  => rb_misc_parameter.f_get_data(p_parameter => 'HTML_TABLE_PARMS',
--                                                                     p_key       => 'bwrkrhst.P_ShowEnrollment') || -- 081801-4
--                                        'width="' || WIDTH || '" SUMMARY= "' ||
--                                        g$_nls.get('BWRKRHS1-0036',
--                                                   'SQL',
--                                                   'This table lists the expected enrollment status.') || '"',
--                        ccaption     => g$_nls.get('BWRKRHS1-0037',
--                                                   'SQL',
--                                                   'Expected Enrollment'));

   IF rb_common.f_sel_robinst_aidy_end_year(aidy) >= 2015 THEN                                                   -- 8180101-1
      --P_ShowNewEnrollment                                                                                       -- 8180101-1
      --   ( pidm   =>  pidm,                                                                                     -- 8180101-1
      --     aidy   =>  aidy,                                                                                     -- 8180101-1
      --     status =>  status                                                                                    -- 8180101-1
      --   ) ;                                                                                                    -- 8180101-1
      GOTO get_out;                                                                                             -- 8180101-1
   END IF;                                                                                                       -- 8180101-1

   IF status = 'F' THEN
      lv_enroll_json := '{"fStatus": {';
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0038', 'SQL', 'Status'));
--      twbkfrmt.p_tablerowclose;

      OPEN est_enroll_pell_c;
      FETCH est_enroll_pell_c
        INTO est_enroll_pell,
             default_option;
      CLOSE est_enroll_pell_c;

      IF est_enroll_pell = 'N' THEN
         -- 80201-3
--         IF default_option = '1' THEN
--           twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0039', 'SQL', 'Full-Time'));
--         ELSIF default_option = '2' THEN
--           twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0040', 'SQL', '3/4 Time'));
--         ELSIF default_option = '3' THEN
--           twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0041', 'SQL', '1/2 Time'));
--         ELSIF default_option = '4' THEN
--           twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0042', 'SQL', 'Less Than 1/2 Time'));
--         END IF;
         --
         lv_enroll_json := lv_enroll_json || '"dfltOption":"' || default_option || '"';
      ELSE
         -- est_enroll_pell = 'Y'
         OPEN period_c;
         FETCH period_c
           INTO summer_t,
                fall,
                winter,
                spring,
                summer_n,
                exp_enroll_stat;
         CLOSE period_c;
         IF exp_enroll_stat IS NOT NULL THEN
--            p_showenrollmentdesc(aidy, NULL, 'RCRAPP1_EXP_ENROLL_STATUS', exp_enroll_stat);
            lv_enroll_json := lv_enroll_json || '"status":"' ||
               f_showenrollmentdesc(aidy, NULL, 'RCRAPP1_EXP_ENROLL_STATUS', exp_enroll_stat) ||
               '"';
         ELSE
--            twbkfrmt.p_tablerowopen;
--            twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0043', 'SQL', 'Unknown'));
            lv_enroll_json := lv_enroll_json || '"status":"unknown"';
--            twbkfrmt.p_tablerowclose;
         END IF;
      END IF;
      lv_enroll_json := lv_enroll_json || '}}';
     --
   ELSE
      lv_enroll_json := '{"tStatus": {"statuses": [';
            -- status = 'T'
            OPEN period_c;
            FETCH period_c
             INTO summer_t,
                  fall,
                  winter,
                  spring,
                  summer_n,
                  exp_enroll_stat;
            IF period_c%FOUND AND
                  (summer_t IS NOT NULL OR fall IS NOT NULL OR winter IS NOT NULL OR
                  spring IS NOT NULL OR summer_n IS NOT NULL) THEN

      --         twbkfrmt.p_tablerowopen;
      --         twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0044', 'SQL', 'Status'));
      --         twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0045', 'SQL', ''));
      --         twbkfrmt.p_tablerowclose;

      --         p_showenrollmentdesc(aidy,
      --                              g$_nls.get('BWRKRHS1-0046', 'SQL', 'Summer'),
      --                              'RCRAPP1_RQST_FA_SUMMER_THIS_YR',
      --                              summer_t);
               lv_enroll_json := lv_enroll_json || '"' ||
                     f_showenrollmentdesc(aidy,
                                    'summer',
                                    'RCRAPP1_RQST_FA_SUMMER_THIS_YR',
                                    summer_t) || '",';
      --         p_showenrollmentdesc(aidy,
      --                              g$_nls.get('BWRKRHS1-0047', 'SQL', 'Fall'),
      --                              'RCRAPP1_RQST_FA_FALL_THIS_YR',
      --                              fall);
               lv_enroll_json := lv_enroll_json || '"' ||
                     f_showenrollmentdesc(aidy,
                                    'fall',
                                    'RCRAPP1_RQST_FA_FALL_THIS_YR',
                                    fall) || '",';
      --         p_showenrollmentdesc(aidy,
      --                              g$_nls.get('BWRKRHS1-0048', 'SQL', 'Winter'),
      --                              'RCRAPP1_RQST_FA_WINTER_NEXT_YR',
      --                              winter);
               lv_enroll_json := lv_enroll_json || '"' ||
                     f_showenrollmentdesc(aidy,
                                    'winter',
                                    'RCRAPP1_RQST_FA_WINTER_NEXT_YR',
                                    winter) || '",';
      --         p_showenrollmentdesc(aidy,
      --                              g$_nls.get('BWRKRHS1-0049', 'SQL', 'Spring'),
      --                              'RCRAPP1_RQST_FA_SPRING_NEXT_YR',
      --                              spring);
               lv_enroll_json := lv_enroll_json || '"' ||
                     f_showenrollmentdesc(aidy,
                                    'spring',
                                    'RCRAPP1_RQST_FA_SPRING_NEXT_YR',
                                    spring) || '",';
      --         p_showenrollmentdesc(aidy,
      --                              g$_nls.get('BWRKRHS1-0050', 'SQL', 'Summer'),
      --                              'RCRAPP1_RQST_FA_SUMMER_NEXT_YR',
      --                              summer_n);
               lv_enroll_json := lv_enroll_json || '"' ||
                     f_showenrollmentdesc(aidy,
                                    'nSummer',
                                    'RCRAPP1_RQST_FA_SUMMER_NEXT_YR',
                                    summer_n) || '"';
         --
      ELSE
--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0051', 'SQL', 'Status'));
--         twbkfrmt.p_tablerowclose;

--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0052', 'SQL', 'Unknown'));
         lv_enroll_json := lv_enroll_json || '"status":"unknown"';
--         twbkfrmt.p_tablerowclose;
      END IF;

      CLOSE period_c;
      lv_enroll_json := lv_enroll_json || ']}}';
   END IF;

   << get_out >>
   ? := lv_enroll_json;
--   twbkfrmt.p_tableclose;
--   htp.br;
end;
--END P_ShowEnrollment;
"""
}



getNewEnrollment {
    sqlText = """
--PROCEDURE P_ShowNewEnrollment
--           ( pidm   NUMBER,
--             aidy   robinst.robinst_aidy_code%TYPE,
--             status rorwebr.rorwebr_enrollment_status%TYPE
--           ) IS
declare
   pidm   NUMBER := ?;
   aidy   robinst.robinst_aidy_code%TYPE := ?;
   status rorwebr.rorwebr_enrollment_status%TYPE := ?;

   TYPE PeriodRecType IS RECORD                                                     -- 8180101-1
            ( period                               rorprst.rorprst_period%TYPE,    -- 8180101-1
              period_desc                          robprds.robprds_desc%TYPE,      -- 8180101-1
              xes                                  rorprst.rorprst_xes%TYPE,       -- 8180101-1
              xes_desc                             rormval.rormval_desc%TYPE       -- 8180101-1
            );                                                                     -- 8180101-1

   TYPE PeriodRecTab IS TABLE OF PeriodRecType;

   lv_year_xes         rorstat.rorstat_xes%TYPE;
   lv_year_desc        rormval.rormval_desc%TYPE;

   lv_PeriodRec        PeriodRecTab;

   lv_unknown          rormval.rormval_desc%TYPE := g$_nls.get('BWRKRHS1-0028', 'SQL', 'Unknown');
   i                   PLS_INTEGER;

   est_enroll_pell     rpbopts.rpbopts_est_enroll_pell_ind%TYPE := NULL;
   default_option      rpbopts.rpbopts_default_option_ind%TYPE := NULL;

   lv_nenroll_json VARCHAR2(32000);

   CURSOR year_c IS
          SELECT rorstat_xes,
                 CASE   WHEN rorstat_xes IS NOT NULL THEN (SELECT rormval_desc
                                                             FROM rormval
                                                            WHERE rormval_column = 'EXP_ENROLL_STATUS'
                                                              AND rormval_code   = x.rorstat_xes
                                                          )
                       ELSE lv_unknown
                 END
            FROM rorstat x
           WHERE rorstat_aidy_code  = aidy
             AND rorstat_pidm       = pidm ;

   CURSOR period_c IS
          SELECT rorprst_period,
                 robprds_desc,
                 rorprst_xes,
                 CASE   WHEN rorprst_xes IS NOT NULL THEN (SELECT rormval_desc
                                                             FROM rormval
                                                            WHERE rormval_column = 'EXP_ENROLL_STATUS'
                                                              AND rormval_code   = x.rorprst_xes
                                                          )
                       ELSE lv_unknown
                 END
            FROM robprds,
                 rorprst x
           WHERE rorprst_period  = robprds_period
             AND rorprst_pidm    = pidm
             AND rorprst_period IN ( SELECT rortprd_period
                                       FROM rortprd,
                                            rorstat
                                      WHERE rorstat_aidy_code  = aidy
                                        AND rorstat_pidm       = pidm
                                        AND rortprd_aidy_code  = rorstat_aidy_code
                                        AND rortprd_aprd_code IN (rorstat_aprd_code,rorstat_aprd_code_pell)
                                   )
       ORDER BY robprds_seq_no ;

   CURSOR est_enroll_pell_c IS
          SELECT rpbopts_est_enroll_pell_ind,
                 rpbopts_default_option_ind
            FROM rpbopts
           WHERE rpbopts_aidy_code = aidy;

BEGIN
   IF status = 'F' THEN
--      twbkfrmt.p_tablerowopen;
--      twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0029', 'SQL', 'Status'));
--      twbkfrmt.p_tablerowclose;
      lv_nenroll_json := '{"fStatus":{';
      OPEN  est_enroll_pell_c;
      FETCH est_enroll_pell_c INTO est_enroll_pell,
                                  default_option;
      CLOSE est_enroll_pell_c;

      IF est_enroll_pell = 'N' THEN
         -- 80201-3
--         IF default_option = '1' THEN
--             twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0030', 'SQL', 'Full-Time'));
--         ELSIF default_option = '2' THEN
--             twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0031', 'SQL', '3/4 Time'));
--         ELSIF default_option = '3' THEN
--             twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0032', 'SQL', '1/2 Time'));
--         ELSIF default_option = '4' THEN
--             twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0033', 'SQL', 'Less Than 1/2 Time'));
--         END IF;
         lv_nenroll_json := lv_nenroll_json || '"status":"' || default_option || '"';
      ELSE
         -- est_enroll_pell = 'Y'
         OPEN  year_c;
         FETCH year_c INTO lv_year_xes,
                           lv_year_desc ;
         CLOSE year_c;
--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledata(lv_year_desc);
         lv_nenroll_json := lv_nenroll_json || '"status":"' || lv_year_desc || '"';
--         twbkfrmt.p_tablerowclose;
      END IF;
      lv_nenroll_json := lv_nenroll_json || '}}';
   ELSE
      -- status = 'T'
      lv_nenroll_json := '{"tStatus":{';
      OPEN  period_c;
      FETCH period_c BULK COLLECT INTO lv_PeriodRec;
      CLOSE period_c;

      IF lv_PeriodRec.COUNT = 0 THEN
--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0034', 'SQL', 'Status'));
--         twbkfrmt.p_tablerowclose;

--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledata(lv_unknown);
         lv_nenroll_json := lv_nenroll_json || '"statuses":["' || lv_unknown || '"]';
--         twbkfrmt.p_tablerowclose;
      ELSE
--         twbkfrmt.p_tablerowopen;
--         twbkfrmt.p_tabledataheader('');
--         twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0035', 'SQL', 'Status'));
--         twbkfrmt.p_tablerowclose;

         lv_nenroll_json := lv_nenroll_json || '"statuses":[';
         FOR i IN lv_PeriodRec.FIRST .. lv_PeriodRec.LAST
         LOOP
--            twbkfrmt.p_tablerowopen;
            if i > 1 then
               lv_nenroll_json := lv_nenroll_json || ',';
            end if;
            --twbkfrmt.p_tabledata(lv_PeriodRec(i).period_desc);
            --twbkfrmt.p_tabledata(lv_PeriodRec(i).xes_desc);
            lv_nenroll_json := lv_nenroll_json || '"' || lv_PeriodRec(i).period_desc || ':' || lv_PeriodRec(i).xes_desc || '"';
--            twbkfrmt.p_tablerowclose;
         END LOOP;
         lv_nenroll_json := lv_nenroll_json || ']';
      END IF;
      lv_nenroll_json := lv_nenroll_json || '}}';
   END IF;

   ? := lv_nenroll_json;
end;
--END P_ShowNewEnrollment;
"""
}



getCostOfAttendance {
    sqlText = """
--PROCEDURE p_showcoa(pidm  NUMBER,
--                    aidy  robinst.robinst_aidy_code%TYPE,
--                    WIDTH VARCHAR2) IS
declare
   pidm  NUMBER := ?;
   aidy  robinst.robinst_aidy_code%TYPE := ?;

   -- p_display_budget
   p_aidy_code rbracmp.rbracmp_aidy_code%TYPE;
   p_pidm      rbracmp.rbracmp_pidm%TYPE;
   p_caption   VARCHAR2(50);
   p_header    VARCHAR2(50);
   p_width     VARCHAR2(50) DEFAULT NULL;
   width_attribute VARCHAR2(50) := '';
   total           NUMBER       := 0;
   lv_BudgetTab    rbkpfrm.BudgetSummaryRecTab;


   lv_budg_json VARCHAR2(32000)  := '{}';

      -- 081401-2
   FUNCTION f_get_pbud_info_access_ind RETURN VARCHAR2 IS
         pbud_info_access_ind rorstat.rorstat_pbud_info_access_ind%TYPE;
   BEGIN
      SELECT rorstat_pbud_info_access_ind
      INTO   pbud_info_access_ind
      FROM   rorstat
      WHERE  rorstat_aidy_code = aidy
      AND    rorstat_pidm = pidm;
      RETURN pbud_info_access_ind;
   EXCEPTION
      WHEN NO_DATA_FOUND THEN
      RETURN 'N';
   END;
BEGIN
   -- 081401-01
   IF (rbk_period_budget.f_period_budget_enabled(aidy) = 'N') OR
      (f_get_pbud_info_access_ind = 'Y') THEN
--      bwrkbudg.p_display_budget(p_aidy_code => aidy,
--                               p_pidm      => pidm,
--                               p_caption   => g$_nls.get('BWRKRHS1-0023',
--                                                         'SQL',
--                                                         'Cost of Attendance'), -- 081500-2
--                               p_header    => g$_nls.get('BWRKRHS1-0024',
--                                                         'SQL',
--                                                         'Component'), -- 081500-2
--                               p_width     => WIDTH);
      p_aidy_code := aidy;
      p_pidm := pidm;
--      p_caption := 'Cost of Attendance';
--      p_header := 'Component';
--      p_width := WIDTH;

    --BEGIN p_display_budget
      IF rbk_period_budget.f_period_budget_enabled(p_aidy_code) = 'N' THEN
--         lv_BudgetTab := f_get_budget(p_aidy_code, p_pidm);
         lv_BudgetTab := bwrkbudg.f_get_budget(p_aidy_code, p_pidm);
      ELSE
--         lv_BudgetTab := rbkpfrm.f_get_budget(p_aidy_code, p_pidm, f_get_budget_efc_ind(p_aidy_code, p_pidm));
         lv_BudgetTab := rbkpfrm.f_get_budget(p_aidy_code, p_pidm, bwrkbudg.f_get_budget_efc_ind(p_aidy_code, p_pidm));
      END IF;

      IF lv_BudgetTab.COUNT > 0 THEN
--         IF p_width IS NOT NULL THEN
--            width_attribute := 'width="' || p_width;
--         END IF;

--         twbkfrmt.P_TableOpen('DATADISPLAY',
--                              cattributes => rb_misc_parameter.F_Get_Data(
--                                                        p_parameter => 'HTML_TABLE_PARMS',
--                                                        p_key       => 'bwrkbudg.P_DispBudg') ||                           -- 081401-1
--                                             width_attribute || '" SUMMARY= "' ||
--                                             g$_nls.get('BWRKBUD1-0002', 'SQL', 'This table lists the cost of attendance.') || '"',
--                              ccaption    =>G$_NLS.FormatMsg('x', 'SQL', p_caption));

         lv_budg_json := '{"budgets":[';
         FOR i IN lv_BudgetTab.FIRST .. lv_BudgetTab.LAST LOOP
--            twbkfrmt.P_TableRowOpen;
            if i > 1 then
               lv_budg_json := lv_budg_json || ',';
            end if;
--            twbkfrmt.P_TableData(lv_BudgetTab(i).description);
            lv_budg_json := lv_budg_json || '{"desc":"' || lv_BudgetTab(i).description ||'",';
--            twbkfrmt.P_TableData(to_char(lv_BudgetTab(i).amount, 'L999G999G999G999D99'), calign => 'right');                -- 081401-1
            lv_budg_json := lv_budg_json || '"amount":' || lv_BudgetTab(i).amount || '}';
--            twbkfrmt.P_TableRowClose;
            total := total + lv_BudgetTab(i).amount;
         END LOOP;
         lv_budg_json := lv_budg_json || '],';

         total := LEAST(total, 999999999999.99);

--         twbkfrmt.P_TableRowOpen;
--         twbkfrmt.P_TableDataLabel(g$_nls.get('BWRKBUD1-0003', 'SQL', 'Total:'), ccolspan => '1');
--         twbkfrmt.P_TableData(to_char(total, 'L999G999G999G999D99'), 'right');
         lv_budg_json := lv_budg_json || '"total":' || total || '}';
--         twbkfrmt.P_TableRowClose;

--         twbkfrmt.P_TableClose;
--         htp.br;
      END IF;
    --END p_display_budget
   END IF;
   ? := lv_budg_json;
end;
--END p_showcoa;
"""
}



getCumLoanInfo {
    sqlText = """
--PROCEDURE P_ShowCumLoanInfo(pidm  NUMBER,
--                            aidy  robinst.robinst_aidy_code%TYPE,
--                            WIDTH VARCHAR2) IS
declare
   pidm  NUMBER := ?;
   aidy  robinst.robinst_aidy_code%TYPE := ?;
   WIDTH VARCHAR2 (30);

   agt_sub_total       rcrlds4.rcrlds4_agt_sub_total%TYPE := 0;
   agt_unsub_total     rcrlds4.rcrlds4_agt_unsub_total%TYPE := 0;
   agt_gr_plus_total   rcrlds4.rcrlds4_agt_gr_plus_total%TYPE := 0;
   agt_plus_total      rcrlds4.rcrlds4_agt_plus_total%TYPE := 0;
   perk_cumulative_amt rcrlds4.rcrlds4_perk_cumulative_amt%TYPE := 0;
   teach_loan_total    rcrlds4.rcrlds4_teach_loan_total%TYPE := 0; -- 80300-6
   proc_date           rcrlds4.rcrlds4_proc_date%TYPE := NULL;

   lv_loan_json VARCHAR2(32000);

   CURSOR loan_info_c IS
     SELECT NVL(rcrlds4_agt_sub_total, 0),
            NVL(rcrlds4_agt_unsub_total, 0),
            NVL(rcrlds4_agt_gr_plus_total, 0),
            NVL(rcrlds4_agt_plus_total, 0),
            NVL(rcrlds4_perk_cumulative_amt, 0),
            NVL(rcrlds4_teach_loan_total, 0), -- 80300-6
            rcrlds4_proc_date
     FROM   rcrlds4
     WHERE  rcrlds4_aidy_code = aidy
     AND    rcrlds4_pidm = pidm
     AND    rcrlds4_curr_rec_ind = 'Y';

BEGIN
   OPEN loan_info_c;
   FETCH loan_info_c
    INTO agt_sub_total,
         agt_unsub_total,
         agt_gr_plus_total,
         agt_plus_total,
         perk_cumulative_amt,
         teach_loan_total, -- 80300-6
         proc_date;

   lv_loan_json := '{';
   IF agt_sub_total <> 0 OR
      agt_unsub_total <> 0 OR
      agt_gr_plus_total <> 0 OR
      agt_plus_total <> 0 OR
      perk_cumulative_amt <> 0 OR
      teach_loan_total <> 0 THEN
      -- 80300-6

--      twbkfrmt.p_tableopen('DATADISPLAY',
--                           cattributes  => rb_misc_parameter.f_get_data(p_parameter => 'HTML_TABLE_PARMS',
--                                                                        p_key       => 'bwrkrhst.P_ShowCumLoanInfo') || -- 081801-4
--                                           'width="' || WIDTH || '" SUMMARY= "' ||
--                                           g$_nls.get('BWRKRHS1-0053',
--                                                      'SQL',
--                                                      'This table lists the cumulative loan information.') || '"',
--                           ccaption     => g$_nls.get('BWRKRHS1-0054',
--                                                      'SQL',
--                                                      'Cumulative Loan Information as of<br>') ||
--                                           to_char(proc_date, g$_date.get_nls_date_format));

      --twbkfrmt.p_tablerowopen;
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0055', 'SQL', 'Loan Type'));
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0056', 'SQL', 'Amount'), 'right');
      --twbkfrmt.p_tablerowclose;

--      P_ShowCumLoanDetail(g$_nls.get('BWRKRHS1-0057', 'SQL', 'Subsidized'),
--                          agt_sub_total);
      lv_loan_json := lv_loan_json || '"subsidized":"' || agt_sub_total || '",';
--      P_ShowCumLoanDetail(g$_nls.get('BWRKRHS1-0058', 'SQL', 'Unsubsidized'),
--                          agt_unsub_total);
      lv_loan_json := lv_loan_json || '"unsubsidized":"' || agt_unsub_total || '",';
--      P_ShowCumLoanDetail(g$_nls.get('BWRKRHS1-0059', 'SQL', 'Graduate PLUS'),
--                          agt_gr_plus_total);
      lv_loan_json := lv_loan_json || '"gradPlus":"' || agt_gr_plus_total || '",';
--      P_ShowCumLoanDetail(g$_nls.get('BWRKRHS1-0060', 'SQL', 'Parent PLUS'),
--                          agt_plus_total);
      lv_loan_json := lv_loan_json || '"parentPlus":"' || agt_plus_total || '",';
--      P_ShowCumLoanDetail(g$_nls.get('BWRKRHS1-0061', 'SQL', 'Perkins'),
--                          perk_cumulative_amt);
      lv_loan_json := lv_loan_json || '"perkins":"' || perk_cumulative_amt || '",';
--      P_ShowCumLoanDetail(g$_nls.get('BWRKRHS1-0062',
--                                     'SQL',
--                                     'Direct Unsubsidized (TEACH)'),
--                          teach_loan_total); -- 80300-6
      lv_loan_json := lv_loan_json || '"directUnsub":"' || teach_loan_total || '"';

--      twbkfrmt.p_tableclose;
--      htp.br;
   END IF;
   lv_loan_json := lv_loan_json || '}';
   CLOSE loan_info_c;

   ? := lv_loan_json;
end;
--END P_ShowCumLoanInfo;
"""
}


getAwardInfo {
    sqlText = """
--P_ShowAwardInfo
declare
   pidm   NUMBER := ?;
   aidy   robinst.robinst_aidy_code%TYPE := ?;

   lv_award_json VARCHAR2(32000) := '{}';
   lv_period_json VARCHAR2(32000):= '{}';


   g_unscheduled VARCHAR2(50) := g\$_nls.get('BWRKRHS1-0000', 'SQL', 'Unscheduled');
   info_access      VARCHAR2(1) := 'N';

   lv_unscheduled_long VARCHAR2(100) := g\$_nls.get('BWRKRHS1-0076', 'SQL', 'year that has not been scheduled for specific term(s)');

   rorwebr_rec rorwebr%ROWTYPE ;

   CURSOR award_detail_c IS
    SELECT rpratrm_aidy_code     awrd_aidy_code,
           rpratrm_period        period,
           robprds_desc          period_desc,
           rprawrd_fund_code     fund_code,
           rfrbase_fund_title    fund_title,
           a.rtvawst_desc        status,
           a.rtvawst_offer_ind   status_offer_ind,
           a.rtvawst_accept_ind  status_accept_ind,
           a.rtvawst_decline_ind status_decline_ind,
           a.rtvawst_cancel_ind  status_cancel_ind,
           NVL(rpratrm_offer_amt,0)     amt,
           NVL(rpratrm_offer_amt,0)     period_offer_amt,
           rpratrm_accept_amt           period_accept_amt,
           rpratrm_decline_amt          period_decline_amt,
           rpratrm_cancel_amt           period_cancel_amt,
           robprds_seq_no        period_seq_no,
           rfrbase_print_seq_no  print_seq_no,
           p.rtvawst_desc        period_status,
           p.rtvawst_offer_ind   period_status_offer_ind,
           p.rtvawst_accept_ind  period_status_accept_ind
    FROM   rprawrd,
           rpratrm,
           rtvawst a, -- rprawrd awst
           robprds,
           rfrbase,
           rtvawst p  -- rpratrm awst                                                                         -- 081801-1
    WHERE  p.rtvawst_code                    = rpratrm_awst_code                                              -- 081801-1
    AND    p.rtvawst_info_access_ind         = 'Y'                                                            -- 081801-1
--  AND    rprawrd_pidm                      = pidm                                                           -- 8.23-1
    AND    rprawrd_awst_code                 = a.rtvawst_code
    AND    NVL(rprawrd_info_access_ind, 'Y') = 'Y'
    AND    rfrbase_info_access_ind           = 'Y'
    AND    rprawrd_fund_code                 = rfrbase_fund_code
    AND    a.rtvawst_info_access_ind         = 'Y'
    AND    rpratrm_pidm                      = pidm                                                           -- 8.23-1
    AND    rprawrd_aidy_code                 = rpratrm_aidy_code
    AND    rprawrd_pidm                      = rpratrm_pidm
    AND    rprawrd_fund_code                 = rpratrm_fund_code
    AND    robprds_period                    = rpratrm_period
    AND    (
             ( NVL(rfrbase_fed_fund_id, '*') = 'PELL'                                                         -- 081000-1
    AND        rpratrm_offer_amt > 0                                                                          -- 081000-1
    AND        bwrkolib.f_checkpellcrossover                                                                  -- 081000-1
                          ( aidy,                                                                             -- 081000-1
                            pidm,                                                                             -- 081000-1
                            rprawrd_aidy_code,                                                                -- 081000-1
                            rpratrm_period                                                                    -- 081000-1
                          ) = 'Y'                                                                             -- 081000-1
             )                                                                                                -- 081000-1
     OR      ( NVL(rfrbase_fed_fund_id, '*') <> 'PELL'                                                        -- 081000-1
--     AND       rprawrd_aidy_code = aidy                                                                     -- 081000-1
     AND       ( ( rpratrm_bbay_code IS NULL                                                                  -- 8.23-1
     AND           rpratrm_aidy_code = aidy                                                                   -- 8.23-1
                 )                                                                                            -- 8.23-1
      OR         ( rpratrm_bbay_code IS NOT NULL                                                              -- 8.23-1
     AND           NVL(rpratrm_aidy_code_funds,                                                               -- 8.23-1
                       rpratrm_aidy_code)       = aidy                                                        -- 8.23-1
                 )
               )
     AND       ( ( rorwebr_rec.rorwebr_term_zero_awrd_ind = 'N'
     AND           rpratrm_offer_amt > 0
                 )
      OR         ( rorwebr_rec.rorwebr_term_zero_awrd_ind = 'Y'
                 )
               )
             )
           )
    UNION ALL
    SELECT rprawrd_aidy_code,
           '~',
           g_unscheduled,
           rprawrd_fund_code,
           rfrbase_fund_title,
           rtvawst_desc,
           rtvawst_offer_ind,
           rtvawst_accept_ind,
           rtvawst_decline_ind,
           rtvawst_cancel_ind,
           NVL(rprawrd_offer_amt,0),
           NVL(rprawrd_offer_amt,0),
           rprawrd_accept_amt,
           rprawrd_decline_amt,
           rprawrd_cancel_amt,
           99999999,
           rfrbase_print_seq_no,
           rtvawst_desc,
           '~',
           '~'
    FROM   rprawrd,
           rtvawst,
           rfrbase
    WHERE  rprawrd_aidy_code = aidy
    AND    rprawrd_pidm = pidm
    AND    rprawrd_awst_code = rtvawst_code
    AND    NVL(rprawrd_info_access_ind, 'Y') = 'Y'
    AND    rfrbase_info_access_ind = 'Y'
    AND    rprawrd_fund_code = rfrbase_fund_code
    AND    rtvawst_info_access_ind = 'Y'
    AND    NOT EXISTS
           (SELECT 'X'
            FROM   rpratrm
            WHERE  rprawrd_aidy_code = rpratrm_aidy_code
            AND    rprawrd_pidm = rpratrm_pidm
            AND    rprawrd_fund_code = rpratrm_fund_code)
    AND    ((rorwebr_rec.rorwebr_fund_zero_amt_ind = 'N' AND rprawrd_offer_amt > 0) OR rorwebr_rec.rorwebr_fund_zero_amt_ind = 'Y')
    ORDER  BY print_seq_no,
              fund_code,
              period_seq_no ;

   TYPE period_award_tab_type IS TABLE OF award_detail_c%ROWTYPE INDEX BY BINARY_INTEGER ;

  TYPE fund_data_rec IS RECORD (
    fund_code rprawrd.rprawrd_fund_code%TYPE,
    fund_title rfrbase.rfrbase_fund_title%TYPE,
    periods period_award_tab_type  -- array of fund/period records, index by period_seq_no
  ) ;

  TYPE fund_data_tab_type IS TABLE OF fund_data_rec INDEX BY BINARY_INTEGER ;
  -- index by binary_integer here because we need the records to be retrievable in the
  -- same order we put them in

  TYPE list_type IS TABLE OF robprds.robprds_desc%TYPE INDEX BY BINARY_INTEGER ;

   lv_period_list list_type ;
   lv_award_data fund_data_tab_type ;

   FUNCTION f_getinfoaccess(pidm NUMBER,
                           aidy robinst.robinst_aidy_code%TYPE) RETURN VARCHAR2 IS

    lv_info_access VARCHAR2(1) := 'N';

    CURSOR getinfoaccess_c IS
      SELECT NVL(rorstat_info_access_ind, rorwebr_null_infoaccess_ind)
      FROM   rorstat,
             rorwebr
      WHERE  rorstat_pidm = pidm
      AND    rorstat_aidy_code = aidy
      AND    rorstat_aidy_code = rorwebr_aidy_code;

  BEGIN
    OPEN getinfoaccess_c;
    FETCH getinfoaccess_c
      INTO lv_info_access;
    CLOSE getinfoaccess_c;

    RETURN lv_info_access;
  END f_getinfoaccess;

  PROCEDURE P_Sel_rorwebr(aidy robinst.robinst_aidy_code%TYPE) IS

    CURSOR get_rorwebr_c( p_aidy_code rorwebr.rorwebr_aidy_code%TYPE ) IS
      SELECT *
      FROM   rorwebr
      WHERE  rorwebr_aidy_code = p_aidy_code ;

  BEGIN
    OPEN get_rorwebr_c( p_aidy_code => aidy ) ;
    FETCH get_rorwebr_c INTO rorwebr_rec ;
    CLOSE get_rorwebr_c ;

    info_access := f_getinfoaccess(pidm, aidy);
  END P_Sel_rorwebr;


FUNCTION f_no_split_period
             ( p_aidy_code              rpratrm.rpratrm_aidy_code%TYPE,
               p_pi                     BINARY_INTEGER,
               p_award_data             fund_data_tab_type
    --         ) RETURN indicator_type IS
             ) RETURN VARCHAR2 IS
    lv_return_ind                       VARCHAR2(1);

    lv_fi                               BINARY_INTEGER ;     -- fund_data index

  BEGIN

    lv_return_ind  :=  'N';

    lv_fi := p_award_data.FIRST ;
    WHILE lv_fi IS NOT NULL LOOP
        IF p_award_data(lv_fi).periods.EXISTS(p_pi) THEN -- period data exists
            IF NVL(p_award_data(lv_fi).periods(p_pi).awrd_aidy_code,p_aidy_code) <> p_aidy_code THEN
                lv_return_ind :=  'Y';
            END IF ;
        END IF ;

        lv_fi := p_award_data.NEXT(lv_fi) ;

     END LOOP ;

    RETURN lv_return_ind;

  END f_no_split_period ;


FUNCTION f_award_exists(pidm     NUMBER,
                          aidy     robinst.robinst_aidy_code%TYPE,
                          webaccpt VARCHAR2 DEFAULT 'N') RETURN BOOLEAN IS

    dummy        VARCHAR2(1);
    return_value BOOLEAN := TRUE;

    -- This cursor is used to test if they have awards. If they don't
    -- have a packing group they can't have any awards.
    CURSOR getpackgroup_c IS
      SELECT 'X'
      FROM   rorstat,
             rorwebr
      WHERE  rorstat_pidm = pidm
      AND    rorstat_aidy_code = aidy
      AND    rorstat_aidy_code = rorwebr_aidy_code
      AND    NVL(rorstat_info_access_ind, rorwebr_null_infoaccess_ind) = 'Y'
      AND    ((rorstat_pgrp_code IS NOT NULL AND
            rorstat_pgrp_code IN
            (SELECT rtvpgrp_code FROM rtvpgrp WHERE rtvpgrp_info_access_ind = 'Y')) OR
            rorstat_pgrp_code IS NULL);

  CURSOR getawddtl_c IS
    SELECT 'X'
    FROM   rprawrd,
           rpratrm,
           rtvawst,
           robprds,
           rfrbase
    WHERE  rprawrd_pidm = pidm
    AND    rprawrd_awst_code = rtvawst_code
    AND    NVL(rprawrd_info_access_ind, 'Y') = 'Y'
    AND    rfrbase_info_access_ind = 'Y'
    AND    rprawrd_fund_code = rfrbase_fund_code
    AND    rtvawst_info_access_ind = 'Y'
    AND    rprawrd_aidy_code = rpratrm_aidy_code
    AND    rprawrd_pidm = rpratrm_pidm
    AND    rprawrd_fund_code = rpratrm_fund_code
    AND    robprds_period = rpratrm_period
    AND    (
             ( NVL(rfrbase_fed_fund_id, '*') = 'PELL'                                                         -- 081000-1
    AND        rpratrm_offer_amt > 0                                                                          -- 081000-1
    AND        bwrkolib.f_checkpellcrossover                                                                  -- 081000-1
                          ( aidy,                                                                             -- 081000-1
                            pidm,                                                                             -- 081000-1
                            rprawrd_aidy_code,                                                                -- 081000-1
                            rpratrm_period                                                                    -- 081000-1
                          ) = 'Y'                                                                             -- 081000-1
             )                                                                                                -- 081000-1
     OR      ( NVL(rfrbase_fed_fund_id, '*') <> 'PELL'                                                        -- 081000-1
--     AND       rprawrd_aidy_code = aidy                                                                     -- 081000-1
     AND       ( ( rpratrm_bbay_code IS NULL                                                                  -- 8.23-1
     AND           rpratrm_aidy_code = aidy                                                                   -- 8.23-1
                 )                                                                                            -- 8.23-1
      OR         ( rpratrm_bbay_code IS NOT NULL                                                              -- 8.23-1
     AND           NVL(rpratrm_aidy_code_funds,                                                               -- 8.23-1
                       rpratrm_aidy_code)       = aidy                                                        -- 8.23-1
                 )
               )
     AND       (
                 ( rorwebr_rec.rorwebr_term_zero_awrd_ind = 'N'
     AND           rpratrm_offer_amt > 0
                 )
      OR           rorwebr_rec.rorwebr_term_zero_awrd_ind = 'Y'
               )
     AND       (
                 ( rorwebr_rec.rorwebr_fund_zero_amt_ind = 'N'
     AND           rprawrd_offer_amt > 0
                 )
      OR         rorwebr_rec.rorwebr_fund_zero_amt_ind = 'Y'
               )
             )
           )
    UNION ALL
    SELECT 'X'
    FROM   rprawrd,
           rtvawst,
           rfrbase
    WHERE  rprawrd_aidy_code = aidy
    AND    rprawrd_pidm = pidm
    AND    rprawrd_awst_code = rtvawst_code
    AND    NVL(rprawrd_info_access_ind, 'Y') = 'Y'
    AND    rfrbase_info_access_ind = 'Y'
    AND    rprawrd_fund_code = rfrbase_fund_code
    AND    rtvawst_info_access_ind = 'Y'
    AND    NOT EXISTS
     (SELECT 'X'
            FROM   rpratrm
            WHERE  rprawrd_aidy_code = rpratrm_aidy_code
            AND    rprawrd_pidm = rpratrm_pidm
            AND    rprawrd_fund_code = rpratrm_fund_code)
    AND    ((rorwebr_rec.rorwebr_fund_zero_amt_ind = 'N' AND rprawrd_offer_amt > 0) OR rorwebr_rec.rorwebr_fund_zero_amt_ind = 'Y');
    /* 081500-1
            SELECT 'X'
              FROM RPRAWRD,
                   RTVAWST,
                   RFRBASE  -- 80300-4
             WHERE RPRAWRD_PIDM      = pidm
               AND RPRAWRD_AWST_CODE = RTVAWST_CODE
               AND NVL(RPRAWRD_INFO_ACCESS_IND, 'Y') = 'Y'
               AND RPRAWRD_FUND_CODE = RFRBASE_FUND_CODE -- 80300-4
               AND RFRBASE_INFO_ACCESS_IND = 'Y'
               AND RTVAWST_INFO_ACCESS_IND = 'Y'
               AND (RPRAWRD_FUND_CODE IN
                     (SELECT RPRATRM_FUND_CODE
                        FROM RPRATRM,
                             ROBPRDS                                                -- 080900-1
                       WHERE 1=1 -- ROBPRDS_AIDY_CODE = aidy                        -- 081201-1
                         AND ROBPRDS_PERIOD    = RPRATRM_PERIOD
                         AND RPRATRM_AIDY_CODE = RPRAWRD_AIDY_CODE
                         AND RPRATRM_PIDM      = RPRAWRD_PIDM
                         AND RPRATRM_FUND_CODE = RPRAWRD_FUND_CODE
                         AND (  (   NVL(RFRBASE_FED_FUND_ID, '*')  = 'PELL'         -- 081000-1
                                AND RPRATRM_OFFER_AMT > 0                           -- 081000-1
                                AND bwrkolib.F_CheckPellCrossover(                  -- 081000-1
                                       aidy,                                        -- 081000-1
                                       pidm,                                        -- 081000-1
                                       RPRAWRD_AIDY_CODE,                           -- 081000-1
                                       RPRATRM_PERIOD) = 'Y'                        -- 081000-1
                                )                                                   -- 081000-1
                             OR (   NVL(RFRBASE_FED_FUND_ID, '*') <> 'PELL'         -- 081000-1
                                AND RPRAWRD_AIDY_CODE = aidy                        -- 081000-1
                                AND (  (term_zero_awrd = 'N' AND RPRATRM_OFFER_AMT > 0)
                                    OR  term_zero_awrd = 'Y')
                                )
                             )
                     )
                   OR NOT EXISTS -- 071401-2
                     (SELECT 'X'
                        FROM RPRATRM
                       WHERE RPRAWRD_AIDY_CODE = RPRATRM_AIDY_CODE
                         AND RPRAWRD_PIDM      = RPRATRM_PIDM
                         AND RPRAWRD_FUND_CODE = RPRATRM_FUND_CODE
                     )
                   )
               AND ( (fund_zero_amt  = 'N' AND RPRAWRD_OFFER_AMT > 0)
                   OR fund_zero_amt  = 'Y')
               AND ( (webAccpt = 'Y' AND F_AllowWebUpdate(pidm, aidy, RPRAWRD_FUND_CODE) = 'Y')
                   OR webAccpt = 'N');
    */
  BEGIN
    -- Check the packing group.If they don't have a group,they don't have awards.
    OPEN getpackgroup_c;
    FETCH getpackgroup_c
      INTO dummy;
    IF getpackgroup_c%NOTFOUND THEN
      return_value := FALSE;
    END IF;
    CLOSE getpackgroup_c;

    -- So they have a packing group, then check to see if there are awards out there.
    OPEN getawddtl_c;
    FETCH getawddtl_c
      INTO dummy;
    IF getawddtl_c%NOTFOUND THEN
      return_value := FALSE;
    END IF;
    CLOSE getawddtl_c;

    RETURN return_value;
  END f_award_exists;

PROCEDURE P_GetAwardData( p_award_data   OUT fund_data_tab_type,
                            p_period_list  OUT list_type )    IS
    lv_fund_indx BINARY_INTEGER := 0 ;
    lv_last_fund_code rprawrd.rprawrd_fund_code%TYPE ;
  BEGIN
    -- Builds a table of unique periods in a student's award package (p_period_list)
    -- Also builds an award detail data structure that looks something like this:
    /*
    award data table (indexed sequentially from 1, orderd by print_seq_no+fund_code)
      -> period award data table (indexed by robprds_seq_no)

    A data example might look like this:

    award_data(1)  -- these indexes are sequential, in the order that funds should appear (print_seq_no+fund_code)
      fund_code  => 'PELL'
      fund_title => 'Federal PELL Grant'
      periods(100) =>    -- simce this is indexed by robprds_seq_no, it can skip values based on the actual data in the tables
          award_detail_c%ROWTYPE: period      => 'FALL_2012'
                                  period_desc => 'Fall 2012'
                                  fund_code   => 'PELL'
                                  fund_title  => 'Federal PELL Grant'
                                  status      => 'ACPT'
                                  ...
      periods(101) =>
          award_detail_c%ROWTYPE: period      => 'SPRING_2013'
                                  period_desc => 'Spring 2013'
                                  fund_code   => 'PELL'
                                  fund_title  => 'Federal PELL Grant'
                                  status      => 'ACPT'
                                  ...
    award_data(2)
      fund_code  => 'STFD'
      fund_title => 'Stafford Loan'
      periods(101) =>
      periods(101) =>
          award_detail_c%ROWTYPE: period      => 'SPRING_2013'
                                  period_desc => 'Spring 2013'
                                  fund_code   => 'STFD'
                                  fund_title  => 'Stafford Loan'
                                  status      => 'ACPT'
                                  ...
    award_data(3)
      ...
    */

    FOR i IN award_detail_c LOOP
      -- only create a new fund record if the fund code has changed
      IF lv_last_fund_code != i.fund_code THEN
        lv_fund_indx := lv_fund_indx + 1 ;
      END IF ;
      lv_last_fund_code := i.fund_code ;

      -- Set members of fund_data_rec
      p_award_data( lv_fund_indx ).fund_code := i.fund_code ;
      p_award_data( lv_fund_indx ).fund_title := i.fund_title ;
      p_award_data( lv_fund_indx ).periods( i.period_seq_no ) := i ;

      -- Build the unique list of periods, indexed by period_seq_no
      p_period_list(i.period_seq_no) := i.period_desc ;
    END LOOP ;

  END P_GetAwardData ;


   -- Draws a table for period awards for the specified period
   --PROCEDURE P_Show_PA_PeriodBlock( period_seq_no robprds.robprds_seq_no%TYPE ) IS
   PROCEDURE P_Show_PA_PeriodBlock( period_seq_no robprds.robprds_seq_no%TYPE,
         lv_period_json IN OUT VARCHAR2) IS
      lv_fi BINARY_INTEGER ;
      lv_total_amt NUMBER ;
      lv_term_desc VARCHAR2(2000) ;
      lv_count NUMBER := 0;                                                                                     -- 8.23-3
   BEGIN
      IF lv_period_list(period_seq_no) = g_unscheduled THEN
         lv_term_desc := lv_unscheduled_long ;
      ELSE
      --   lv_term_desc := lv_period_list(period_seq_no) ;

         IF f_no_split_period                                                                                          -- 8.23-3
              ( p_aidy_code     =>  aidy,                                                                              -- 8.23-3
                p_pi            =>  period_seq_no,                                                                     -- 8.23-3
                p_award_data    =>  lv_award_data                                                                      -- 8.23-3
              ) = 'Y' THEN                                                                                             -- 8.23-3

            --lv_term_desc  :=  G$_NLS.FormatMsg('x', 'SQL',                                                          -- 8.23-3
            --                                f_getinfotext('bwrkrhst.P_AwardOverviewTab', 'BBAY_DESC'),                 -- 8.23-3
            --                                lv_period_list(period_seq_no));                                            -- 8.23-3
            lv_term_desc := lv_period_list(period_seq_no);
         ELSE                                                                                                          -- 8.23-3
            --lv_term_desc  :=  G$_NLS.FormatMsg('x', 'SQL',                                                           -- 8.23-3
            --                               f_getinfotext('bwrkrhst.P_AwardOverviewTab', 'TERM_DESC'),                  -- 8.23-3
            --                               lv_period_list(period_seq_no));                                             -- 8.23-3
            lv_term_desc := lv_period_list(period_seq_no);
         END IF;                                                                                                        -- 8.23-3
      END IF ;

      lv_period_json := lv_period_json || '{';
      --twbkfrmt.p_tableopen('DATADISPLAY',
      --                     cattributes  => rb_misc_parameter.f_get_data(p_parameter => 'HTML_TABLE_PARMS',
      --                                                                  p_key       => 'bwrkrhst.P_AcceptAwardOfferTab') || -- 080500-4
      --                                     'width="' || WIDTH || '" SUMMARY= "' ||
      --                                     g$_nls.get('BWRKRHS1-0084',
      --                                                'SQL',
      --                                                'This table lists the award information.') || '"',
      --                     ccaption     => lv_term_desc);                                                               -- 8.23-3
   --                         ccaption     => g$_nls.get('BWRKRHS1-0084',                                                  -- 8.23-3
   --                                                    'SQL',                                                            -- 8.23-3
   --                                                    'Financial Aid Award for the %01%',                               -- 8.23-3
   --                                                    lv_term_desc ));
      lv_period_json := lv_period_json || '"termDesc":"' || lv_term_desc || '",';
      -- First row of header
      --twbkfrmt.p_tablerowopen;
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0085', 'SQL', 'Fund'));
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0086', 'SQL', 'Status'));
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0087', 'SQL', 'Total'));
      --twbkfrmt.p_tablerowclose;

      lv_period_json := lv_period_json || '"periodAwards": [';
      lv_fi := lv_award_data.FIRST ;
      WHILE lv_fi IS NOT NULL LOOP
         --twbkfrmt.p_tablerowopen;

         IF lv_award_data(lv_fi).periods.EXISTS( period_seq_no ) THEN
            lv_count := lv_count + 1;
            if lv_count > 1 then
               lv_period_json := lv_period_json || ',';
            end if;
            --P_PrintCell_FundTitle( p_fund_code => lv_award_data(lv_fi).fund_code,
            --                       p_fund_title => lv_award_data(lv_fi).fund_title,
            --                       p_aidy_code => aidy ) ;
            lv_period_json := lv_period_json || '{"fundTitle":"' || lv_award_data(lv_fi).fund_title || '",';

            --twbkfrmt.p_tabledata( lv_award_data(lv_fi).periods(period_seq_no).period_status ) ;
            lv_period_json := lv_period_json || '"status":"' || lv_award_data(lv_fi).periods(period_seq_no).period_status || '",';
            --twbkfrmt.p_tabledata( TO_CHAR(lv_award_data(lv_fi).periods(period_seq_no).amt, 'L999G999G999D99'),
            --                      calign => 'right' ) ;
            lv_period_json := lv_period_json || '"amount":' || nvl(lv_award_data(lv_fi).periods(period_seq_no).amt,0) || '}';
            --twbkfrmt.p_tablerowclose;

            lv_total_amt := NVL(lv_total_amt,0) + lv_award_data(lv_fi).periods(period_seq_no).amt ;
         END IF ;
         lv_fi := lv_award_data.NEXT(lv_fi) ;
      END LOOP ;
      lv_period_json := lv_period_json || '],';

      --twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0088', 'SQL', 'Total'), cattributes=>'style="font-weight: bold;"');
      --htp.print('<td></td>') ;
      --twbkfrmt.p_tabledata( TO_CHAR( lv_total_amt, 'L999G999G999D99'),
      --                               calign => 'right');  -- grand total for the period
      lv_period_json := lv_period_json || '"total": ' || nvl(lv_total_amt,0) || '}';

      --twbkfrmt.p_tablerowclose;
      --twbkfrmt.p_tableclose;
   END P_Show_PA_PeriodBlock ;


   --PROCEDURE P_Show_PA_V IS
   FUNCTION P_Show_PA_V RETURN VARCHAR2 IS
      lv_pi BINARY_INTEGER ;
      lv_periods_json VARCHAR2(32000);
      lv_count NUMBER := 0;
   BEGIN
      lv_pi := lv_period_list.FIRST ;
      lv_periods_json := '{"periods":[';
      WHILE lv_pi IS NOT NULL LOOP
         lv_count := lv_count + 1;
         if lv_count > 1 then
            lv_periods_json := lv_periods_json || ',';
         end if;
         --P_Show_PA_PeriodBlock(lv_pi) ;
         P_Show_PA_PeriodBlock(lv_pi, lv_periods_json) ;
         --htp.br ;
         lv_pi := lv_period_list.NEXT(lv_pi) ;
      END LOOP ;
      lv_periods_json := lv_periods_json || ']}';

      return lv_periods_json;
   END P_Show_PA_V ;

   PROCEDURE P_Calc_AwardAidyAmtStatus( p_fi                 BINARY_INTEGER,
                                        p_out_amt        OUT NUMBER,
                                        p_out_status_img OUT VARCHAR2,
                                        lv_offer_amt     OUT NUMBER,
                                        lv_accept_amt    OUT NUMBER,
                                        lv_decline_amt   OUT NUMBER,
                                        lv_cancel_amt    OUT NUMBER) IS
      lv_pi BINARY_INTEGER ;
      lv_offered BOOLEAN := FALSE ;
      lv_accepted BOOLEAN := FALSE ;
      lv_declined BOOLEAN := FALSE ;
      lv_cancelled BOOLEAN := FALSE ;
   BEGIN
      lv_offer_amt := NULL ;
      lv_accept_amt  := NULL ;
      lv_decline_amt := NULL ;
      lv_cancel_amt  := NULL ;

      lv_pi := lv_award_data(p_fi).periods.FIRST ;
      WHILE lv_pi IS NOT NULL LOOP
         p_out_amt := NVL(p_out_amt,0) + NVL(lv_award_data(p_fi).periods(lv_pi).amt,0) ;

         -- Sum up the individual column amounts ofrd/acpt/decl/cncl
         IF lv_award_data(p_fi).periods(lv_pi).period_offer_amt IS NOT NULL THEN
            lv_offer_amt := NVL(lv_offer_amt,0) + lv_award_data(p_fi).periods(lv_pi).period_offer_amt ;
         END IF ;

         IF lv_award_data(p_fi).periods(lv_pi).period_accept_amt IS NOT NULL THEN
            lv_accept_amt := NVL(lv_accept_amt,0) + lv_award_data(p_fi).periods(lv_pi).period_accept_amt ;
         END IF ;

         IF lv_award_data(p_fi).periods(lv_pi).period_decline_amt IS NOT NULL THEN
            lv_decline_amt := NVL(lv_decline_amt,0) + lv_award_data(p_fi).periods(lv_pi).period_decline_amt ;
         END IF ;

         IF lv_award_data(p_fi).periods(lv_pi).period_cancel_amt IS NOT NULL THEN
            lv_cancel_amt := NVL(lv_cancel_amt,0) + lv_award_data(p_fi).periods(lv_pi).period_cancel_amt ;
         END IF ;

         -- Set ofrd/acpt/decl/cncl booleans so we can calculate the status image to display later
         IF lv_award_data(p_fi).periods(lv_pi).period_status_offer_ind = 'Y' OR
               (lv_award_data(p_fi).periods(lv_pi).period = '~' AND lv_award_data(p_fi).periods(lv_pi).status_offer_ind = 'Y') THEN
            lv_offered := TRUE ;
         END IF ;

         IF lv_award_data(p_fi).periods(lv_pi).period_status_accept_ind = 'Y' OR
               (lv_award_data(p_fi).periods(lv_pi).period = '~' AND lv_award_data(p_fi).periods(lv_pi).status_accept_ind = 'Y') THEN
            lv_accepted := TRUE ;
         END IF ;

         IF lv_award_data(p_fi).periods(lv_pi).status_decline_ind = 'Y' THEN
            lv_declined := TRUE ;
         END IF ;

         IF lv_award_data(p_fi).periods(lv_pi).status_cancel_ind = 'Y' THEN
            lv_cancelled := TRUE ;
         END IF ;

         lv_pi := lv_award_data(p_fi).periods.NEXT(lv_pi) ;
      END LOOP ;

      IF lv_offered = TRUE THEN
         --IF rorwebr_rec.rorwebr_offer_image IS NOT NULL THEN
            p_out_status_img := 'offer' ;
         --END IF ;
      ELSIF lv_accepted = TRUE THEN
         --IF rorwebr_rec.rorwebr_accept_image IS NOT NULL THEN
            p_out_status_img := 'accept' ;
         --END IF ;
      ELSIF lv_declined = TRUE THEN
         --IF rorwebr_rec.rorwebr_decline_image IS NOT NULL THEN
            p_out_status_img := 'decline' ;
         --END IF ;
      ELSIF lv_cancelled = TRUE THEN
         --IF rorwebr_rec.rorwebr_cancel_image IS NOT NULL THEN
            p_out_status_img := 'cancel' ;
         --END IF ;
      END IF ;
   END P_Calc_AwardAidyAmtStatus ;


   PROCEDURE P_Show_AA(lv_aidyr_json IN OUT VARCHAR2) IS
      lv_fi BINARY_INTEGER ;
      lv_amt NUMBER := 0 ;
      lv_total_amt NUMBER ;
      lv_term_desc VARCHAR2(100) ;
      lv_status_img rorwebr.rorwebr_decline_image%TYPE ;
      lv_offer_amt NUMBER ;
      lv_accept_amt  NUMBER ;
      lv_decline_amt NUMBER ;
      lv_cancel_amt  NUMBER ;
      lv_total_offer_amt NUMBER ;
      lv_total_accept_amt  NUMBER ;
      lv_total_decline_amt NUMBER ;
      lv_total_cancel_amt  NUMBER ;

      lv_count NUMBER := 0;
   BEGIN
      --twbkfrmt.p_tableopen('DATADISPLAY',
      --                     cattributes  => rb_misc_parameter.f_get_data(p_parameter => 'HTML_TABLE_PARMS',
      --                                                                  p_key       => 'bwrkrhst.P_AcceptAwardOfferTab') || -- 080500-4
      --                                     'width="' || WIDTH || '" SUMMARY= "' ||
      --                                     g$_nls.get('BWRKRHS1-0089',
      --                                                'SQL',
      --                                                'This table lists the award information.') || '"',
      --                     ccaption     => g$_nls.get('BWRKRHS1-0090',
      --                                                'SQL',
      --                                                'Financial Aid Award for the %01%',
      --                                                bwrkolib.f_validaidy(aidy) ));
      lv_aidyr_json := lv_aidyr_json || '{';
      -- Header
      --twbkfrmt.p_tablerowopen;
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0091', 'SQL', 'Fund'));
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0092', 'SQL', 'Status'));
      --IF rorwebr_rec.rorwebr_aidy_award_ind = 'D' THEN  -- then also display ofrd/acpt/decl/cncl amounts
      --  twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0093', 'SQL', 'Offered'));
      --  twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0094', 'SQL', 'Accepted'));
      --  IF rorwebr_rec.rorwebr_fund_zero_amt_ind != 'N' THEN
      --    twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0095', 'SQL', 'Declined'));
      --    twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0096', 'SQL', 'Cancelled'));
      --  END IF ;
      --END IF ;
      --twbkfrmt.p_tabledataheader(g$_nls.get('BWRKRHS1-0097', 'SQL', 'Total'));
      --twbkfrmt.p_tablerowclose;

      lv_aidyr_json := lv_aidyr_json || '"aidAwards":[';
      lv_fi := lv_award_data.FIRST ;
      WHILE lv_fi IS NOT NULL LOOP
         --twbkfrmt.p_tablerowopen;
         lv_count := lv_count + 1;
         if lv_count > 1 then
            lv_aidyr_json := lv_aidyr_json || ',';
         end if;
         lv_aidyr_json := lv_aidyr_json || '{';
         --P_PrintCell_FundTitle( p_fund_code => lv_award_data(lv_fi).fund_code,
         --                       p_fund_title => lv_award_data(lv_fi).fund_title,
         --                       p_aidy_code => aidy ) ;
         lv_aidyr_json := lv_aidyr_json || '"fundTitle":"' || lv_award_data(lv_fi).fund_title || '"';
         P_Calc_AwardAidyAmtStatus( lv_fi, lv_amt, lv_status_img,
                                   lv_offer_amt, lv_accept_amt, lv_decline_amt,
                                   lv_cancel_amt ) ;
         --twbkfrmt.p_tabledata( lv_status_img ) ;
         lv_aidyr_json := lv_aidyr_json || ',"status":"' || lv_status_img || '"';


         IF rorwebr_rec.rorwebr_aidy_award_ind = 'D' THEN  -- then also display ofrd/acpt/decl/cncl amounts
            --twbkfrmt.p_tabledata( TO_CHAR( lv_offer_amt, 'L999G999G999D99'),
            --                      calign => 'right' ) ;
            lv_aidyr_json := lv_aidyr_json || ',"offerAmt":' || nvl(lv_offer_amt,0) || ',';
            --twbkfrmt.p_tabledata( TO_CHAR( lv_accept_amt, 'L999G999G999D99'),
            --                      calign => 'right' ) ;
            lv_aidyr_json := lv_aidyr_json || '"acceptAmt":' || nvl(lv_accept_amt,0) || '';
            IF rorwebr_rec.rorwebr_fund_zero_amt_ind != 'N' THEN
               --twbkfrmt.p_tabledata( TO_CHAR( lv_decline_amt, 'L999G999G999D99'),
               --                      calign => 'right' ) ;
               lv_aidyr_json := lv_aidyr_json || ',"declineAmt":' || nvl(lv_decline_amt,0) || ',';
               --twbkfrmt.p_tabledata( TO_CHAR( lv_cancel_amt, 'L999G999G999D99'),
               --                    calign => 'right' ) ;
               lv_aidyr_json := lv_aidyr_json || '"cancelAmt":' || nvl(lv_cancel_amt,0) || '';
            END IF ;

            lv_total_offer_amt := NVL(lv_total_offer_amt,0) + lv_offer_amt ;

            IF lv_accept_amt IS NOT NULL THEN
               lv_total_accept_amt := NVL(lv_total_accept_amt,0) + lv_accept_amt ;
            END IF ;

            IF lv_decline_amt IS NOT NULL THEN
               lv_total_decline_amt := NVL(lv_total_decline_amt,0) + lv_decline_amt ;
            END IF ;

            IF lv_cancel_amt IS NOT NULL THEN
               lv_total_cancel_amt := NVL(lv_total_cancel_amt,0) + lv_cancel_amt ;
            END IF ;

         END IF ;

         --twbkfrmt.p_tabledata( TO_CHAR( lv_amt, 'L999G999G999D99'),
         --                      calign => 'right' ) ;
         lv_aidyr_json := lv_aidyr_json || ',"amount":' || nvl(lv_amt,0);
         --twbkfrmt.p_tablerowclose;
         lv_aidyr_json := lv_aidyr_json || '}';

         lv_total_amt := NVL(lv_total_amt,0) + lv_amt ;

         lv_amt := 0 ;
         lv_fi := lv_award_data.NEXT(lv_fi) ;
      END LOOP ;
      lv_aidyr_json := lv_aidyr_json || ']';

      --twbkfrmt.p_tabledata(g$_nls.get('BWRKRHS1-0098', 'SQL', 'Total'), cattributes=>'style="font-weight: bold;"');
      --htp.print('<td></td>') ;

      IF rorwebr_rec.rorwebr_aidy_award_ind = 'D' THEN  -- then also display ofrd/acpt/decl/cncl amounts
         --twbkfrmt.p_tabledata( TO_CHAR( lv_total_offer_amt, 'L999G999G999D99'),
         --                      calign => 'right',cattributes=>'style="font-weight: bold;"' ) ;
         lv_aidyr_json := lv_aidyr_json || ',"totalOfferAmt":' || nvl(lv_total_offer_amt,0) || ',';
         --twbkfrmt.p_tabledata( TO_CHAR( lv_total_accept_amt, 'L999G999G999D99'),
         --                      calign => 'right',cattributes=>'style="font-weight: bold;"' ) ;
         lv_aidyr_json := lv_aidyr_json || '"totalAcceptAmt":' || nvl(lv_total_accept_amt,0);
         IF rorwebr_rec.rorwebr_fund_zero_amt_ind != 'N' THEN
            --twbkfrmt.p_tabledata( TO_CHAR( lv_total_decline_amt, 'L999G999G999D99'),
            --                     calign => 'right',cattributes=>'style="font-weight: bold;"' ) ;
            lv_aidyr_json := lv_aidyr_json || ',"totalDeclineAmt":' || nvl(lv_total_decline_amt,0) || ',';
            --twbkfrmt.p_tabledata( TO_CHAR( lv_total_cancel_amt, 'L999G999G999D99'),
            --                     calign => 'right',cattributes=>'style="font-weight: bold;"' ) ;
            lv_aidyr_json := lv_aidyr_json || '"totalCancelAmt":' || nvl(lv_total_cancel_amt,0);
         END IF ;
      END IF ;

      --twbkfrmt.p_tabledata( TO_CHAR( lv_total_amt, 'L999G999G999D99'),
      --                      calign => 'right',cattributes=>'style="font-weight: bold;"');  -- grand total for the year
      lv_aidyr_json := lv_aidyr_json || ',"totalAmt":' || nvl(lv_total_amt,0);
      --twbkfrmt.p_tablerowclose;

      --twbkfrmt.p_tableclose;
      lv_aidyr_json := lv_aidyr_json || '}';
   END P_Show_AA ;

BEGIN
   --bwrkolib.P_ProcessUserDefTxt( pidm, aidy, 'FA' ) ;
   P_Sel_rorwebr(aidy);

   -- Check for no awards
   IF NOT f_award_exists(pidm, aidy) OR info_access = 'N' THEN
      lv_award_json := '{}';
      lv_period_json := '{}';
   --   RETURN;
   -- END IF;
   else

   P_GetAwardData( lv_award_data, lv_period_list ) ;

   IF rorwebr_rec.rorwebr_aidy_award_ind IN ('D','S') THEN
     -- The logic for D and S Aidyear Awards is so similar that
     -- they are both handled by the same procedure
     --P_Show_AA ;  -- Show Aidyear Awards
     lv_award_json := '{"aidYearAwards":';
     P_Show_AA(lv_award_json);
     lv_award_json := lv_award_json || '}';
   END IF ; -- IF rorwebr_rec.rorwebr_aidy_award_ind = 'N' or anything else, don't display anything

   -- determine if we need a spacer - only if one of each table is shown
   --IF rorwebr_rec.rorwebr_aidy_award_ind != 'N' AND
   --   rorwebr_rec.rorwebr_prds_award_ind != 'N' THEN
   --  htp.br ;
   --END IF ;

   --IF rorwebr_rec.rorwebr_prds_award_ind = 'H' THEN
   --  P_Show_PA_H ;  -- Show Period Awards - Horizontal
   --ELSIF rorwebr_rec.rorwebr_prds_award_ind = 'V' THEN
   --  P_Show_PA_V ;  -- Show Period Awards - Vertical
   --ELSIF rorwebr_rec.rorwebr_prds_award_ind = 'D' THEN
   --  P_Show_PA_D ;  -- Show Period Awards - Double
   --END IF ; -- IF rorwebr_rec.rorwebr_prds_award_ind = 'N' or anything else, don't display anything

   lv_period_json := P_Show_PA_V;
   end if;
   --htp.br;

   --EXCEPTION WHEN OTHERS THEN
   --  htp.p('<hr><font size="+3"><bold>' || SQLERRM || '<br><pre>' || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE || '</pre></font><hr>') ;
--END P_ShowAwardInfo;
   ? := lv_award_json;
   ? := lv_period_json;
END;
"""
}



getRorwebrRec {
    sqlText = """
--PROCEDURE P_Sel_rorwebr(aidy robinst.robinst_aidy_code%TYPE) IS
declare
   pidm NUMBER := ?;
   aidy robinst.robinst_aidy_code%TYPE := ?;

   lv_rorwebr_json VARCHAR(32000) := '{}';

   rorwebr_rec rorwebr%ROWTYPE ;

   CURSOR get_rorwebr_c( p_aidy_code rorwebr.rorwebr_aidy_code%TYPE ) IS
   SELECT *
   FROM   rorwebr
   WHERE  rorwebr_aidy_code = p_aidy_code ;

   FUNCTION f_getinfoaccess(pidm NUMBER,
                           aidy robinst.robinst_aidy_code%TYPE) RETURN VARCHAR2 IS

      lv_info_access VARCHAR2(1) := 'N';

      CURSOR getinfoaccess_c IS
         SELECT NVL(rorstat_info_access_ind, rorwebr_null_infoaccess_ind)
         FROM   rorstat,
                rorwebr
         WHERE  rorstat_pidm = pidm
         AND    rorstat_aidy_code = aidy
         AND    rorstat_aidy_code = rorwebr_aidy_code;

   BEGIN
      OPEN getinfoaccess_c;
      FETCH getinfoaccess_c
        INTO lv_info_access;
      CLOSE getinfoaccess_c;

      RETURN lv_info_access;
   END f_getinfoaccess;

BEGIN
   OPEN get_rorwebr_c( p_aidy_code => aidy ) ;
   FETCH get_rorwebr_c INTO rorwebr_rec ;
   CLOSE get_rorwebr_c ;

   lv_rorwebr_json := '{';
   lv_rorwebr_json := lv_rorwebr_json || '"need_calc_ind":"' || rorwebr_rec.rorwebr_need_calc_ind || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"housing_status_ind":"' || rorwebr_rec.rorwebr_housing_status_ind || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"enrollment_status":"' || rorwebr_rec.rorwebr_enrollment_status || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"coa_ind":"' || rorwebr_rec.rorwebr_coa_ind || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"cum_loan_ind":"' || rorwebr_rec.rorwebr_cum_loan_ind || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"term_zero_awrd_ind":"' || rorwebr_rec.rorwebr_term_zero_awrd_ind || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"fund_zero_amt_ind":"' || rorwebr_rec.rorwebr_fund_zero_amt_ind || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"info_access":"' || f_getinfoaccess(pidm, aidy) || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"aidYearDesc":"' || bwrkolib.f_validaidy(aidy) || '",';
   lv_rorwebr_json := lv_rorwebr_json || '"aid_year":' ||rb_common.f_sel_robinst_aidy_end_year(aidy);
   lv_rorwebr_json := lv_rorwebr_json || '}';

   ? := lv_rorwebr_json;

end;
--END P_Sel_rorwebr;
"""
}